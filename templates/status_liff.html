<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç‹€æ…‹å›å ±</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .title{font-weight:700}
    .muted{color:#666;font-size:14px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{padding:8px 10px;border:0;border-radius:10px;cursor:pointer}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
</head>
<body>
  <h3>å›å ±é™„è¿‘å»æ‰€ç‹€æ…‹</h3>
  <div id="loading">å–å¾—ä½ç½®ä¸­â€¦</div>
  <div id="list"></div>

  <script>
    const LIFF_ID = "{{ liff_id }}";
    const qs = new URLSearchParams(location.search);
    const qsLat = parseFloat(qs.get("lat")||"");
    const qsLon = parseFloat(qs.get("lon")||"");

    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) e.setAttribute(k,v);
      for (const c of children) e.appendChild(typeof c==="string" ? document.createTextNode(c) : c);
      return e;
    }

    async function getPos() {
      if (!isNaN(qsLat) && !isNaN(qsLon)) return {lat: qsLat, lon: qsLon};
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error("ç„¡æ³•å–å¾—å®šä½"));
        navigator.geolocation.getCurrentPosition(
          p=>res({lat:p.coords.latitude, lon:p.coords.longitude}),
          e=>rej(e), {enableHighAccuracy:true, timeout:8000}
        );
      });
    }

    async function fetchCandidates(lat, lon){
      const r = await fetch(`/api/status_candidates?lat=${lat}&lon=${lon}`);
      return await r.json();
    }

    async function reportStatus(lat, lon, status, btns){
      // é¿å…é€£é»
      btns.forEach(b=>b.disabled = true);
      let user = { userId:"", displayName:"" };
      try { user = await liff.getProfile(); } catch(e) {}
      try {
        const body = { lat, lon, status, user_id: user.userId||"", display_name: user.displayName||"", note: "" };
        const r = await fetch("/api/status_report", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(j.ok){
          alert("å·²å›å ±ï¼š" + status);
          if (liff.isInClient()) liff.closeWindow();
        } else {
          alert("å›å ±å¤±æ•—ï¼Œç¨å¾Œå†è©¦");
        }
      } catch (e) {
        alert("ç¶²è·¯éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦");
      } finally {
        btns.forEach(b=>b.disabled = false);
      }
    }

    function render(list){
      const root = document.getElementById("list");
      root.innerHTML = "";
      list.forEach(item=>{
        const card = el("div",{class:"card"});
        const title = el("div",{class:"title"},[ item.title ]);
        const addr  = el("div",{class:"muted"},[ item.address || (item.lat+","+item.lon) ]);
        const dist  = el("div",{class:"muted"},[ Math.round(item.distance) + " å…¬å°º" ]);
        const row   = el("div",{class:"row"});

        const btns = [
          el("button",{},["ğŸŸ¡ æœ‰äººæ’éšŠ"]),
          el("button",{},["ğŸ§» ç¼ºè¡›ç”Ÿç´™"]),
          el("button",{},["â›” æš«åœä½¿ç”¨"]),
          el("button",{},["âœ… æ¢å¾©æ­£å¸¸"]),
        ];
        const labels = ["æœ‰äººæ’éšŠ","ç¼ºè¡›ç”Ÿç´™","æš«åœä½¿ç”¨","æ¢å¾©æ­£å¸¸"];
        btns.forEach((b,i)=>{
          b.addEventListener("click", ()=>reportStatus(item.lat,item.lon,labels[i],btns));
          row.appendChild(b);
        });

        card.appendChild(title);
        card.appendChild(addr);
        card.appendChild(dist);
        card.appendChild(row);
        root.appendChild(card);
      });
    }

    async function main(){
      document.getElementById("loading").innerText = "åˆå§‹åŒ– LIFFâ€¦";
      try { await liff.init({ liffId: LIFF_ID }); } catch(e) { /* å¤±æ•—ä¹Ÿå¯ç”¨ web ç‰ˆ */ }

      document.getElementById("loading").innerText = "å®šä½ä¸­â€¦";
      let pos;
      try { pos = await getPos(); }
      catch(e){
        document.getElementById("loading").innerText = "å®šä½å¤±æ•—ï¼Œè«‹å› LINE å…è¨±å®šä½å¾Œé‡è©¦";
        return;
      }

      document.getElementById("loading").innerText = "è¼‰å…¥é™„è¿‘å»æ‰€â€¦";
      const {ok, candidates} = await fetchCandidates(pos.lat, pos.lon);
      if(!ok || !candidates || !candidates.length){
        document.getElementById("loading").innerText = "é™„è¿‘æ‰¾ä¸åˆ°å»æ‰€";
        return;
      }
      document.getElementById("loading").remove();
      render(candidates);
    }
    main();
  </script>
</body>
</html>
