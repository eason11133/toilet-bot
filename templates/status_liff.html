<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="t_title">å›å ±é™„è¿‘å»æ‰€ç‹€æ…‹</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;line-height:1.6}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .title{font-weight:700}
    .muted{color:#666;font-size:14px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{padding:8px 10px;border:0;border-radius:10px;cursor:pointer}
    .debug{background:#fff8dc;border:1px dashed #f0ad4e;padding:8px;border-radius:8px;margin:8px 0}
    .error{color:#c00;white-space:pre-wrap;margin-top:6px}
    .hint{font-size:14px;color:#555;background:#f6f7fb;border:1px solid #e5e6f0;border-radius:10px;padding:10px;margin-top:8px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
    .btn-primary{background:#3b82f6;color:#fff;border-color:#3b82f6}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
</head>
<body>
  <h3 id="t_h3">å›å ±é™„è¿‘å»æ‰€ç‹€æ…‹</h3>

  <div class="debug" id="debug">
    <div>LIFF_ID: <code id="dbg-liff"></code></div>
    <div>PUBLIC_URL: <code id="dbg-url"></code></div>
    <div>Query: <code id="dbg-q"></code></div>
    <div>LANG: <code id="dbg-lang"></code></div>
  </div>

  <div id="loading">åˆå§‹åŒ–ä¸­â€¦</div>
  <div id="error" class="error"></div>
  <div id="assist" class="hint" style="display:none"></div>
  <div id="actions" class="btns" style="display:none"></div>
  <div id="list"></div>

  <script>
    /** ===== i18n ===== */
    const I18N = {
      zh: {
        title: "å›å ±é™„è¿‘å»æ‰€ç‹€æ…‹",
        init: "åˆå§‹åŒ–ä¸­â€¦",
        init_liff: "åˆå§‹åŒ– LIFFâ€¦",
        locating: "å®šä½ä¸­â€¦",
        loading: "è¼‰å…¥é™„è¿‘å»æ‰€â€¦",
        none: "é™„è¿‘æ‰¾ä¸åˆ°å»æ‰€",
        perm_denied: "å®šä½å¤±æ•—ï¼šä½¿ç”¨è€…æ‹’çµ•æä¾›å®šä½ï¼ˆcode: 1ï¼‰",
        allow_then: "è«‹å…è¨±å®šä½å¾Œå†è©¦",
        loc_failed_prefix: "å®šä½å¤±æ•—ï¼š",
        loc_failed_short: "å®šä½å¤±æ•—",
        try_again: "é‡æ–°å˜—è©¦å®šä½",
        assist_retry: "ä½ å¯ä»¥é»ã€Œé‡æ–°å˜—è©¦å®šä½ã€ï¼Œæˆ–åœ¨èŠå¤©å®¤å‚³é€ä½ç½®å¾Œå†é–‹æ­¤é ã€‚",
        assist_denied: "æˆ–è€…ï¼šä½ ä¹Ÿå¯ä»¥åœ¨å‚³é€ä½ç½®çµ¦æ©Ÿå™¨äººå¾Œï¼Œå†å›ä¾†é»é€™å€‹é é¢ï¼ˆæœƒè‡ªå‹•å¸¶å…¥ä½ å‰›å‰›å‚³çš„ä½ç½®ï¼‰ã€‚",
        liff_id_missing: "LIFF_ID æœªæ­£ç¢ºæ³¨å…¥",
        liff_failed: "LIFF åˆå§‹åŒ–å¤±æ•—ï¼š",
        geo_unsup: "ç€è¦½å™¨ä¸æ”¯æ´å®šä½",
        ios_tip: "iPhoneï¼šåˆ°ã€Œè¨­å®š â†’ LINE â†’ ä½ç½®ã€æ”¹ç‚ºã€Œä½¿ç”¨ App æœŸé–“ã€å¾Œè¿”å›æ­¤é å†è©¦ã€‚",
        and_tip: "Androidï¼šé•·æŒ‰ LINE App åœ–ç¤º â†’ App è³‡è¨Š â†’ æ¬Šé™ â†’ ä½ç½® â†’ å…è¨±ï¼Œå›åˆ°æ­¤é å†è©¦ã€‚",
        other_tip: "è«‹åˆ°æ‰‹æ©Ÿçš„ LINE App æ¬Šé™è¨­å®šï¼Œå…è¨±ã€Œä½ç½®ã€å¾Œå›åˆ°æ­¤é å†è©¦ã€‚",
        meters: " å…¬å°º",
        status_labels: ["æœ‰äººæ’éšŠ","ç¼ºè¡›ç”Ÿç´™","æš«åœä½¿ç”¨","æ¢å¾©æ­£å¸¸"],
        status_buttons: ["ğŸŸ¡ æœ‰äººæ’éšŠ","ğŸ§» ç¼ºè¡›ç”Ÿç´™","â›” æš«åœä½¿ç”¨","âœ… æ¢å¾©æ­£å¸¸"],
        report_ok: "å·²å›å ±ï¼š",
        report_fail: "å›å ±å¤±æ•—ï¼Œç¨å¾Œå†è©¦",
        neterr: "ç¶²è·¯éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦"
      },
      en: {
        title: "Report Restroom Status",
        init: "Initializingâ€¦",
        init_liff: "Initializing LIFFâ€¦",
        locating: "Getting locationâ€¦",
        loading: "Loading nearby restroomsâ€¦",
        none: "No nearby restrooms found",
        perm_denied: "Location failed: permission denied (code: 1)",
        allow_then: "Please allow location access and try again",
        loc_failed_prefix: "Location failed: ",
        loc_failed_short: "Location failed",
        try_again: "Try again",
        assist_retry: "You can tap â€œTry againâ€, or send a location in chat and reopen this page.",
        assist_denied: "Or send your location to the bot, then reopen this page (it will use the location you sent).",
        liff_id_missing: "LIFF_ID not injected",
        liff_failed: "LIFF init failed: ",
        geo_unsup: "Geolocation not supported",
        ios_tip: "iPhone: Settings â†’ LINE â†’ Location â†’ While Using, then return and try again.",
        and_tip: "Android: App info â†’ Permissions â†’ Location â†’ Allow, then return and try again.",
        other_tip: "Please allow Location permission for LINE, then return and try again.",
        meters: " m",
        status_labels: ["Queue","No paper","Closed","Back to normal"],
        status_buttons: ["ğŸŸ¡ Queue","ğŸ§» No paper","â›” Closed","âœ… Normal"],
        report_ok: "Reported: ",
        report_fail: "Report failed. Try again later.",
        neterr: "Network error. Please try again."
      }
    };

    function normLang(x){
      x = (x || "").toLowerCase();
      if (x.startsWith("en")) return "en";
      return "zh";
    }
    function getQueryLang(){
      const p = new URLSearchParams(location.search);
      const q = p.get("lang");
      return q ? normLang(q) : "";
    }
    function ensureLangInUrl(lang){
      const p = new URLSearchParams(location.search);
      if (p.get("lang")) return;
      p.set("lang", lang);
      history.replaceState({}, "", location.pathname + "?" + p.toString());
    }

    // å¾Œç«¯æ³¨å…¥
    const LIFF_ID = "{{ liff_id|default('', true) }}";
    const PUBLIC_URL = "{{ public_url|default('', true) }}";

    // Debug é¡¯ç¤º
    document.getElementById("dbg-liff").textContent = LIFF_ID || "(empty)";
    document.getElementById("dbg-url").textContent = PUBLIC_URL || "(empty)";
    document.getElementById("dbg-q").textContent = location.search || "(none)";

    const qs = new URLSearchParams(location.search);
    const qsLat = parseFloat(qs.get("lat")||"");
    const qsLon = parseFloat(qs.get("lon")||"");

    function el(tag, attrs={}, children=[]){
      const e=document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)) e.setAttribute(k,v);
      for(const c of children) e.appendChild(typeof c==="string"?document.createTextNode(c):c);
      return e;
    }

    // --- UI helpers ---
    function setError(text){
      document.getElementById("error").textContent = text || "";
    }
    function setAssist(html){
      const a = document.getElementById("assist");
      if (html) { a.innerHTML = html; a.style.display = ""; }
      else { a.style.display = "none"; }
    }
    function setActions(btnDefs){
      const wrap = document.getElementById("actions");
      wrap.innerHTML = "";
      if (!btnDefs || !btnDefs.length) { wrap.style.display="none"; return; }
      btnDefs.forEach(def=>{
        const b = document.createElement("button");
        b.className = "btn " + (def.primary ? "btn-primary" : "");
        b.textContent = def.text;
        b.onclick = def.onClick;
        wrap.appendChild(b);
      });
      wrap.style.display="";
    }

    function explainPermission(os, T){
      if (os === "ios") return T.ios_tip;
      if (os === "android") return T.and_tip;
      return T.other_tip;
    }

    // --- å®šä½ ---
    async function getPos(T){
      if(!isNaN(qsLat) && !isNaN(qsLon)) return {lat:qsLat, lon:qsLon};
      return new Promise((res, rej)=>{
        if(!navigator.geolocation) return rej(new Error(T.geo_unsup));
        navigator.geolocation.getCurrentPosition(
          p=>res({lat:p.coords.latitude, lon:p.coords.longitude}),
          e=>rej(e), {enableHighAccuracy:true, timeout:10000}
        );
      });
    }

    // --- API ---
    async function fetchCandidates(lat, lon, LANG){
      const r = await fetch(`/api/status_candidates?lat=${lat}&lon=${lon}&lang=${encodeURIComponent(LANG)}`);
      return await r.json();
    }

    async function reportStatus(lat, lon, status, btns, LANG, T){
      btns.forEach(b=>b.disabled = true);
      let user = { userId:"", displayName:"" };
      try { if (window.liff) user = await liff.getProfile(); } catch(e) {}

      try {
        const body = {
          lat, lon,
          status,
          user_id:user.userId||"",
          display_name:user.displayName||"",
          note:"",
          lang: LANG
        };
        const r = await fetch("/api/status_report", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(j.ok){
          alert(T.report_ok + status);
          if (window.liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
        }else{
          alert(T.report_fail);
        }
      } catch(e){
        alert(T.neterr);
      } finally {
        btns.forEach(b=>b.disabled = false);
      }
    }

    function render(list, LANG, T){
      const root=document.getElementById("list");
      root.innerHTML="";
      list.forEach(item=>{
        const card=el("div",{class:"card"});
        const title=el("div",{class:"title"},[item.title]);
        const addr=el("div",{class:"muted"},[item.address || (item.lat+","+item.lon)]);
        const dist=el("div",{class:"muted"},[Math.round(item.distance)+T.meters]);
        const row=el("div",{class:"row"});

        const btnTexts = T.status_buttons;
        const labels   = T.status_labels;

        const btns = [
          el("button",{},[btnTexts[0]]),
          el("button",{},[btnTexts[1]]),
          el("button",{},[btnTexts[2]]),
          el("button",{},[btnTexts[3]]),
        ];

        btns.forEach((b,i)=>{
          b.addEventListener("click",()=>reportStatus(item.lat,item.lon,labels[i],btns, LANG, T));
          row.appendChild(b);
        });

        card.appendChild(title); card.appendChild(addr); card.appendChild(dist); card.appendChild(row);
        root.appendChild(card);
      });
    }

    async function startFlow(LANG, T){
      const loading=document.getElementById("loading");
      setError(""); setAssist(""); setActions([]);

      loading.textContent = T.locating;

      try{
        const pos = await getPos(T);

        loading.textContent = T.loading;
        const resp = await fetchCandidates(pos.lat, pos.lon, LANG);
        const ok = !!resp.ok;
        const candidates = resp.candidates || resp.data || resp.items || [];

        if(!ok || !candidates || !candidates.length){
          loading.textContent = T.none;
          return;
        }

        loading.remove();
        render(candidates, LANG, T);

      }catch(e){
        const os = (window.liff && liff.getOS) ? liff.getOS() : "";

        if (e && (e.code === 1 || String(e).toLowerCase().includes("denied"))) {
          setError(T.perm_denied);
          setAssist(`${explainPermission(os, T)}<br>${T.assist_denied}`);
          setActions([{ text: T.try_again, primary:true, onClick: ()=>startFlow(LANG, T) }]);
          loading.textContent = T.allow_then;
        } else {
          setError(T.loc_failed_prefix + (e?.message || e));
          setAssist(T.assist_retry);
          setActions([{ text: T.try_again, primary:true, onClick: ()=>startFlow(LANG, T) }]);
          loading.textContent = T.loc_failed_short;
        }
      }
    }

    async function initLiffBestEffort(){
      if (!window.liff || !LIFF_ID) return false;
      try { await liff.init({ liffId: LIFF_ID }); return true; }
      catch (e) { return false; }
    }

    async function detectLangAfterInit(){
      // 1) URL
      const q = getQueryLang();
      if (q) return q;

      // 2) LIFFï¼ˆéœ€è¦ init å¾Œæ‰æº–ï¼‰
      try {
        if (window.liff && typeof liff.getLanguage === "function") {
          const l = liff.getLanguage();
          if (l) return normLang(l);
        }
      } catch {}

      // 3) fallback
      return normLang(navigator.language || "zh");
    }

    async function main(){
      const loading=document.getElementById("loading");
      loading.textContent = I18N.zh.init_liff;

      // å…ˆ initï¼ˆæˆåŠŸæœ€å¥½ï¼Œå¤±æ•—ä¹Ÿæ²’é—œä¿‚ï¼‰
      const inited = await initLiffBestEffort();

      // å†æ±ºå®šèªè¨€ï¼ˆé€™æ™‚ liff.getLanguage æ‰æ¯”è¼ƒæº–ï¼‰
      const LANG = await detectLangAfterInit();
      ensureLangInUrl(LANG);

      const T = I18N[LANG] || I18N.zh;

      document.documentElement.lang = (LANG === "en") ? "en" : "zh-Hant";
      document.title = T.title;
      document.getElementById("t_title").textContent = T.title;
      document.getElementById("t_h3").textContent = T.title;
      document.getElementById("dbg-lang").textContent = LANG;

      loading.textContent = T.init;

      // å¦‚æœ liff_id æ ¹æœ¬æ²’æ³¨å…¥ï¼Œæç¤ºï¼ˆä½†ä»å¯ç¹¼çºŒç”¨ç€è¦½å™¨å®šä½ï¼‰
      if (!LIFF_ID) setError(T.liff_id_missing);
      else if (!inited) setError(T.liff_failed + "(init error)");

      await startFlow(LANG, T);
    }

    main();
  </script>
</body>
</html>
