<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>回報附近廁所狀態</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;line-height:1.6}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .title{font-weight:700}
    .muted{color:#666;font-size:14px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{padding:8px 10px;border:0;border-radius:10px;cursor:pointer}
    .debug{background:#fff8dc;border:1px dashed #f0ad4e;padding:8px;border-radius:8px;margin:8px 0}
    .error{color:#c00;white-space:pre-wrap;margin-top:6px}
    .hint{font-size:14px;color:#555;background:#f6f7fb;border:1px solid #e5e6f0;border-radius:10px;padding:10px;margin-top:8px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer}
    .btn-primary{background:#3b82f6;color:#fff;border-color:#3b82f6}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
</head>
<body>
  <h3>回報附近廁所狀態</h3>

  <div class="debug" id="debug">
    <div>LIFF_ID: <code id="dbg-liff"></code></div>
    <div>PUBLIC_URL: <code id="dbg-url"></code></div>
    <div>Query: <code id="dbg-q"></code></div>
  </div>

  <div id="loading">初始化中…</div>
  <div id="error" class="error"></div>
  <div id="assist" class="hint" style="display:none"></div>
  <div id="actions" class="btns" style="display:none"></div>
  <div id="list"></div>

  <script>
    // 後端注入
    const LIFF_ID = "{{ liff_id }}";
    const PUBLIC_URL = "{{ public_url }}";

    // Debug 顯示
    document.getElementById("dbg-liff").textContent = LIFF_ID;
    document.getElementById("dbg-url").textContent = PUBLIC_URL;
    document.getElementById("dbg-q").textContent = location.search || "(none)";

    const qs = new URLSearchParams(location.search);
    const qsLat = parseFloat(qs.get("lat")||"");
    const qsLon = parseFloat(qs.get("lon")||"");

    function el(tag, attrs={}, children=[]){
      const e=document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)) e.setAttribute(k,v);
      for(const c of children) e.appendChild(typeof c==="string"?document.createTextNode(c):c);
      return e;
    }

    // --- UI helpers ---
    function setError(text){
      const box=document.getElementById("error");
      box.textContent = text || "";
    }
    function setAssist(html){
      const a = document.getElementById("assist");
      if (html) {
        a.innerHTML = html;
        a.style.display = "";
      } else {
        a.style.display = "none";
      }
    }
    function setActions(btnDefs){
      const wrap = document.getElementById("actions");
      wrap.innerHTML = "";
      if (!btnDefs || !btnDefs.length) { wrap.style.display="none"; return; }
      btnDefs.forEach(def=>{
        const b = document.createElement("button");
        b.className = "btn " + (def.primary ? "btn-primary" : "");
        b.textContent = def.text;
        b.onclick = def.onClick;
        wrap.appendChild(b);
      });
      wrap.style.display="";
    }

    // --- 定位 ---
    async function getPos(){
      if(!isNaN(qsLat) && !isNaN(qsLon)) return {lat:qsLat, lon:qsLon};
      return new Promise((res, rej)=>{
        if(!navigator.geolocation) return rej(new Error("瀏覽器不支援定位"));
        navigator.geolocation.getCurrentPosition(
          p=>res({lat:p.coords.latitude, lon:p.coords.longitude}),
          e=>rej(e), {enableHighAccuracy:true, timeout:10000}
        );
      });
    }

    // --- API ---
    async function fetchCandidates(lat, lon){
      const r = await fetch(`/api/status_candidates?lat=${lat}&lon=${lon}`);
      return await r.json();
    }

    async function reportStatus(lat, lon, status, btns){
      btns.forEach(b=>b.disabled = true);
      let user = { userId:"", displayName:"" };
      try { user = await liff.getProfile(); } catch(e) {}
      try {
        const body = { lat, lon, status, user_id:user.userId||"", display_name:user.displayName||"", note:"" };
        const r = await fetch("/api/status_report", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(j.ok){
          alert("已回報：" + status);
          if (liff.isInClient()) liff.closeWindow();
        }else{
          alert("回報失敗，稍後再試");
        }
      } catch(e){
        alert("網路錯誤，稍後再試");
      } finally {
        btns.forEach(b=>b.disabled = false);
      }
    }

    function render(list){
      const root=document.getElementById("list");
      root.innerHTML="";
      list.forEach(item=>{
        const card=el("div",{class:"card"});
        const title=el("div",{class:"title"},[item.title]);
        const addr=el("div",{class:"muted"},[item.address || (item.lat+","+item.lon)]);
        const dist=el("div",{class:"muted"},[Math.round(item.distance)+" 公尺"]);
        const row=el("div",{class:"row"});
        const btns=[
          el("button",{},["🟡 有人排隊"]),
          el("button",{},["🧻 缺衛生紙"]),
          el("button",{},["⛔ 暫停使用"]),
          el("button",{},["✅ 恢復正常"]),
        ];
        const labels=["有人排隊","缺衛生紙","暫停使用","恢復正常"];
        btns.forEach((b,i)=>{
          b.addEventListener("click",()=>reportStatus(item.lat,item.lon,labels[i],btns));
          row.appendChild(b);
        });
        card.appendChild(title); card.appendChild(addr); card.appendChild(dist); card.appendChild(row);
        root.appendChild(card);
      });
    }

    function explainPermission(os){
      if (os === "ios") {
        return "iPhone：到「設定 → LINE → 位置」改為「使用 App 期間」後返回此頁再試。";
      } else if (os === "android") {
        return "Android：長按 LINE App 圖示 → App 資訊 → 權限 → 位置 → 允許，回到此頁再試。";
      }
      return "請到手機的 LINE App 權限設定，允許「位置」後回到此頁再試。";
    }

    async function startFlow(){
      const loading=document.getElementById("loading");
      setError(""); setAssist(""); setActions([]);

      loading.textContent="定位中…";
      try{
        const pos = await getPos();

        loading.textContent="載入附近廁所…";
        const {ok, candidates} = await fetchCandidates(pos.lat, pos.lon);
        if(!ok || !candidates || !candidates.length){
          loading.textContent = "附近找不到廁所";
          return;
        }
        loading.remove();
        render(candidates);
      }catch(e){
        // 針對權限被拒絕（code=1）做友善提示
        const os = (window.liff && liff.getOS) ? liff.getOS() : "";
        if (e && (e.code === 1 || String(e).toLowerCase().includes("denied"))) {
          setError("定位失敗：使用者拒絕提供定位（code: 1）");
          setAssist(`
            ${explainPermission(os)}<br>
            或者：你也可以在傳送位置給機器人後，再回來點這個頁面（會自動帶入你剛剛傳的位置）。
          `);
          setActions([
            { text:"重新嘗試定位", primary:true, onClick: ()=>startFlow() }
          ]);
          loading.textContent = "請允許定位後再試";
        } else {
          setError("定位失敗：" + (e?.message || e));
          setAssist("你可以點「重新嘗試定位」，或在聊天室傳送位置後再開此頁。");
          setActions([
            { text:"重新嘗試定位", primary:true, onClick: ()=>startFlow() }
          ]);
          loading.textContent = "定位失敗";
        }
      }
    }

    async function main(){
      const loading=document.getElementById("loading");
      loading.textContent="初始化 LIFF…";

      try{
        if (LIFF_ID && LIFF_ID !== "{{ liff_id }}") {
          await liff.init({ liffId: LIFF_ID });
        } else {
          setError("LIFF_ID 未正確注入");
        }
      }catch(e){
        // LIFF 失敗也允許繼續（用瀏覽器定位）
        setError("LIFF 初始化失敗：" + (e?.message || e));
      }

      // 啟動主流程（會自動處理帶參數或裝置定位）
      startFlow();
    }
    main();
  </script>
</body>
</html>
