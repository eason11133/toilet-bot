<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="t_title">新增廁所</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;margin:0;background:#f7f7f7;color:#111}
    .wrap{max-width:720px;margin:18px auto;padding:0 14px}
    h1{font-size:28px;margin:10px 0 6px}
    .muted{color:#667085;line-height:1.6}
    .card{background:#fff;border:1px solid #e6e9ef;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea{width:100%;box-sizing:border-box;padding:10px 12px;margin-top:6px;border:1px solid #d0d7de;border-radius:10px}
    textarea{resize:vertical}
    .btn{margin-top:14px;background:#3578e5;color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{font-size:13px;color:#667085;margin-top:6px}
    .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#1a7f37;color:#fff;padding:10px 14px;border-radius:10px;display:none;box-shadow:0 2px 10px rgba(0,0,0,.18)}
    .toast.err{background:#b00020}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="t_h1">新增廁所</h1>
    <div class="muted" id="t_intro">請盡量提供樓層與入口提示，能大幅降低使用者迷路風險。</div>

    <div class="card">
      <label id="t_name_lab">廁所名稱 *</label>
      <input id="name" placeholder="例如：五常公園 公廁 / XX商場" required/>
      <div class="note" id="t_name_note">建築物內請寫到館別/翼/區域，例如：A館南棟 2F 廁所。</div>

      <label id="t_uid_lab">你的 LINE ID</label>
      <input id="uid" placeholder="(auto)" readonly />
      <div class="note" id="t_uid_note">系統會自動帶入你的 LINE UID。</div>

      <label id="t_addr_lab">地址 *</label>
      <input id="address" placeholder="請輸入完整地址，例如：新北市..." required/>
      <div class="note" id="t_addr_note">若剛在 LINE 傳了位置，這裡會自動帶入 OSM 友善地址；不是要新增此地點就直接修改或刪除即可。</div>

      <label id="t_lat_lab">緯度 (lat) *</label>
      <input id="lat" placeholder="25.xxxx" required/>

      <label id="t_lon_lab">經度 (lon) *</label>
      <input id="lon" placeholder="121.xxxx" required/>

      <label id="t_floor_lab">樓層 / 位置（選填）</label>
      <input id="floor_hint" placeholder="例：地下1F / 2F / 入口旁"/>

      <label id="t_ent_lab">入口提示（選填）</label>
      <textarea id="entrance_hint" rows="3" placeholder="例：從北側大門進入右轉，靠近電梯旁"></textarea>

      <button class="btn" id="btn">送出</button>
      <div class="note" id="t_priv_note">送出代表你同意我們用於改善服務；可隨時要求刪除。</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  const I18N = {
    zh: {
      title:"新增廁所",
      intro:"請盡量提供樓層與入口提示，能大幅降低使用者迷路風險。",
      name_lab:"廁所名稱 *",
      name_ph:"例如：五常公園 公廁 / XX商場",
      name_note:"建築物內請寫到館別/翼/區域，例如：A館南棟 2F 廁所。",
      uid_lab:"你的 LINE ID",
      uid_note:"系統會自動帶入你的 LINE UID。",
      addr_lab:"地址 *",
      addr_ph:"請輸入完整地址，例如：新北市...",
      addr_note:"若剛在 LINE 傳了位置，這裡會自動帶入 OSM 友善地址；不是要新增此地點就直接修改或刪除即可。",
      lat_lab:"緯度 (lat) *",
      lon_lab:"經度 (lon) *",
      floor_lab:"樓層 / 位置（選填）",
      floor_ph:"例：地下1F / 2F / 入口旁",
      ent_lab:"入口提示（選填）",
      ent_ph:"例：從北側大門進入右轉，靠近電梯旁",
      btn:"送出",
      priv:"送出代表你同意我們用於改善服務；可隨時要求刪除。",
      missing:"請填寫必填欄位（名稱、地址、座標）",
      sending:"送出中…",
      ok:"已送出，感謝！",
      fail:"送出失敗，請稍後再試",
    },
    en: {
      title:"Add Restroom",
      intro:"Please include floor and entrance hints to reduce the chance users get lost.",
      name_lab:"Restroom name *",
      name_ph:"e.g., Wuchang Park / XX Mall",
      name_note:"For indoor locations, include building/wing/area, e.g., Building A South Wing 2F Restroom.",
      uid_lab:"Your LINE ID",
      uid_note:"We’ll auto-fill your LINE UID.",
      addr_lab:"Address *",
      addr_ph:"Enter full address…",
      addr_note:"If you just shared your location in LINE, we may auto-fill a friendly OSM address. Edit it if needed.",
      lat_lab:"Latitude (lat) *",
      lon_lab:"Longitude (lon) *",
      floor_lab:"Floor / location (optional)",
      floor_ph:"e.g., B1 / 2F / near entrance",
      ent_lab:"Entrance hint (optional)",
      ent_ph:"e.g., Enter from north gate, turn right, next to the elevator",
      btn:"Submit",
      priv:"By submitting, you agree we may use it to improve the service. You can request deletion anytime.",
      missing:"Please fill required fields (name, address, coordinates).",
      sending:"Submitting…",
      ok:"Submitted. Thank you!",
      fail:"Submit failed. Please try again.",
    }
  };

  function normLang(x){
    x = (x || "").toLowerCase();
    if (x.startsWith("en")) return "en";
    return "zh";
  }
  function getLang(){
    const p = new URLSearchParams(location.search);
    const q = p.get("lang");
    if (q) return normLang(q);
    return normLang(navigator.language || "zh");
  }
  const LANG = getLang();
  const T = I18N[LANG] || I18N.zh;
  document.documentElement.lang = (LANG === "en") ? "en" : "zh-Hant";

  const setText=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=v;};
  setText("t_title", T.title);
  setText("t_h1", T.title);
  setText("t_intro", T.intro);
  setText("t_name_lab", T.name_lab);
  setText("t_name_note", T.name_note);
  setText("t_uid_lab", T.uid_lab);
  setText("t_uid_note", T.uid_note);
  setText("t_addr_lab", T.addr_lab);
  setText("t_addr_note", T.addr_note);
  setText("t_lat_lab", T.lat_lab);
  setText("t_lon_lab", T.lon_lab);
  setText("t_floor_lab", T.floor_lab);
  setText("t_ent_lab", T.ent_lab);
  setText("btn", T.btn);
  setText("t_priv_note", T.priv);

  document.getElementById("name").placeholder = T.name_ph;
  document.getElementById("address").placeholder = T.addr_ph;
  document.getElementById("floor_hint").placeholder = T.floor_ph;
  document.getElementById("entrance_hint").placeholder = T.ent_ph;
  document.title = T.title;

  // Fill from query params
  const qs = new URLSearchParams(location.search);
  const q = (k)=>qs.get(k)||"";
  const fillIfEmpty=(id,val)=>{const el=document.getElementById(id); if(el && !el.value && val) el.value=val;};

  fillIfEmpty("uid", q("user_id") || q("uid"));
  fillIfEmpty("address", q("address"));
  fillIfEmpty("lat", q("lat"));
  fillIfEmpty("lon", q("lon"));

  // Submit
  const btn = document.getElementById("btn");
  const toast = document.getElementById("toast");
  function showToast(msg, err=false){
    toast.textContent = msg;
    toast.classList.toggle("err", err);
    toast.style.display="block";
    setTimeout(()=>toast.style.display="none", 2200);
  }

  btn.addEventListener("click", async ()=>{
    const payload = {
      name: document.getElementById("name").value.trim(),
      address: document.getElementById("address").value.trim(),
      lat: document.getElementById("lat").value.trim(),
      lon: document.getElementById("lon").value.trim(),
      uid: document.getElementById("uid").value.trim(),
      floor_hint: document.getElementById("floor_hint").value.trim(),
      entrance_hint: document.getElementById("entrance_hint").value.trim(),
      source: "user",
      lang: LANG
    };

    if (!payload.name || !payload.address || !payload.lat || !payload.lon) {
      showToast(T.missing, true);
      return;
    }

    btn.disabled = true;
    btn.textContent = T.sending;

    try{
      const r = await fetch("/submit_toilet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      if (r.ok && j.ok) {
        showToast(T.ok);
        setTimeout(()=>{ try { window.close(); } catch(e){} }, 800);
      } else {
        showToast((j.message || T.fail), true);
        btn.disabled = false;
        btn.textContent = T.btn;
      }
    }catch(e){
      console.error(e);
      showToast(T.fail, true);
      btn.disabled = false;
      btn.textContent = T.btn;
    }
  });
</script>
</body>
</html>
