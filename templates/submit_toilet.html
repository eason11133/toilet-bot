<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title id="t_title">æ–°å¢å»æ‰€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #3498db;
      --primary-hover: #2980b9;
      --ok: #16a34a;
      --err: #dc2626;
      --shadow: 0 2px 6px rgba(0,0,0,.08);
      --radius: 12px;
      --chip:#eff6ff;
      --chip-b:#93c5fd;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { font-size: 28px; margin: 0 0 10px; letter-spacing: .5px; }
    p.sub { margin: 0 0 18px; color: var(--muted); }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
    label { display: block; margin: 14px 0 6px; font-weight: 600; }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px 12px;
      border: 1px solid #d1d5db; border-radius: 10px;
      font-size: 16px; background: #fff;
    }
    textarea { resize: vertical; min-height: 80px; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 720px) { .row.two { grid-template-columns: 1fr 1fr; } .row.three { grid-template-columns: 1fr 1fr 1fr; } }
    button {
      margin-top: 18px;
      background: var(--primary); color: #fff;
      border: none; border-radius: 10px;
      padding: 12px 18px; font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: var(--primary-hover); }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .msg { margin-top: 14px; padding: 10px 12px; border-radius: 10px; display: none; }
    .msg.ok { background: #ecfdf5; color: var(--ok); display: block; }
    .msg.err { background: #fef2f2; color: var(--err); display: block; }
    .footer-note { margin-top: 16px; color: var(--muted); font-size: 13px; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .chip { background:var(--chip); border:1px solid var(--chip-b); color:#1d4ed8; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; }
    .inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .inline a { color:#2563eb; text-decoration: none; }
    .inline a:hover { text-decoration: underline; }
    .hr { height:1px; background:#e5e7eb; margin:16px 0; }
    .small { font-size:12px; color:#6b7280; }
  </style>
  <!-- å¯ç”¨æ–¼è®€å– LINE å…§èªè¨€ï¼ˆå¤–éƒ¨ç€è¦½å™¨å°± fallbackï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 id="t_h1">æ–°å¢å»æ‰€</h1>
    <p class="sub" id="t_sub">è«‹ç›¡é‡æä¾›æ¨“å±¤èˆ‡å…¥å£æç¤ºï¼Œèƒ½å¤§å¹…é™ä½ä½¿ç”¨è€…è¿·è·¯é¢¨éšªã€‚</p>

    <div class="card">
      <form id="toiletForm" autocomplete="on">
        <div class="row two">
          <div>
            <label for="name" id="t_lab_name">å»æ‰€åç¨± <span style="color:#ef4444">*</span></label>
            <input id="name" name="name" type="text" placeholder="ä¾‹å¦‚ï¼šäº”å¸¸å…¬åœ’ å…¬å» / XXå•†å ´ å—æ£Ÿ 2F å»æ‰€" required />
            <div class="hint" id="t_hint_name">å»ºç¯‰ç‰©å…§è«‹å¯«åˆ°é¤¨åˆ¥/ç¿¼/å€åŸŸï¼Œä¾‹ï¼šAé¤¨ å—æ£Ÿ 2F å»æ‰€ã€‚</div>
          </div>
          <div>
            <label for="user_id" id="t_lab_uid">ä½ çš„ LINE ID</label>
            <input id="user_id" name="user_id" type="text" value="{{ request.args.get('uid','web') }}" readonly />
            <div class="hint" id="t_hint_uid">ç³»çµ±æœƒè‡ªå‹•å¸¶å…¥ä½ çš„ LINE UIDã€‚</div>
          </div>
        </div>

        <label for="address" id="t_lab_addr">åœ°å€ <span style="color:#ef4444">*</span></label>
        <input
          id="address"
          name="address"
          type="text"
          placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼Œä¾‹å¦‚ï¼šæ–°åŒ—å¸‚ ä¸‰é‡å€ äº”è¯è¡— 7å·· 30è™Ÿ"
          value="{{ preset_address or '' }}"
          required
        />
        <div class="hint" id="t_hint_addr">
          è‹¥å‰›åœ¨ LINE å‚³äº†ä½ç½®ï¼Œé€™è£¡æœƒè‡ªå‹•å¸¶å…¥ OSM å‹å–„åœ°å€ï¼›ä¸æ˜¯è¦æ–°å¢æ­¤åœ°é»å°±ç›´æ¥ä¿®æ”¹æˆ–åˆªé™¤å³å¯ã€‚
        </div>

        <!-- ğŸ“ åº§æ¨™ -->
        <div class="row two">
          <div>
            <label for="lat" id="t_lab_lat">ç·¯åº¦ (lat)</label>
            <input id="lat" name="lat" type="text" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š25.033964" value="{{ preset_lat or (request.args.get('lat') or '') }}">
          </div>
          <div>
            <label for="lon" id="t_lab_lon">ç¶“åº¦ (lon)</label>
            <input id="lon" name="lon" type="text" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š121.564468" value="{{ preset_lon or (request.args.get('lon') or '') }}">
          </div>
        </div>
        <div class="inline">
          <button type="button" id="btnGeo">ç”¨æˆ‘ç¾åœ¨çš„ä½ç½®</button>
          <a id="mapPreview" href="#" target="_blank" rel="noopener">Google åœ°åœ–é è¦½</a>
          <span class="small" id="t_map_note">ï¼ˆæœƒä»¥ lat/lon æˆ–åœ°å€é–‹å•Ÿï¼‰</span>
        </div>

        <div class="hr"></div>

        <!-- ğŸ¢ æ¨“å±¤ / ä½ç½® -->
        <div class="row two">
          <div>
            <label for="level" id="t_lab_level">æ¨“å±¤</label>
            <select id="level" name="level">
              <option value="" id="t_opt_level0">â€” é¸æ“‡æ¨“å±¤ / æˆ¶å¤– â€”</option>
              <option value="æˆ¶å¤–ï¼ˆç„¡å»ºç¯‰ï¼‰" id="t_opt_outdoor">æˆ¶å¤–ï¼ˆç„¡å»ºç¯‰ï¼‰</option>
              <option value="B3">B3</option>
              <option value="B2">B2</option>
              <option value="B1">B1</option>
              <option value="1F" id="t_opt_1f">1Fï¼ˆåœ°é¢ï¼‰</option>
              <option value="2F">2F</option>
              <option value="3F">3F</option>
              <option value="4F">4F</option>
              <option value="5F+" id="t_opt_5p">5F ä»¥ä¸Š</option>
              <option value="å±‹é ‚" id="t_opt_roof">å±‹é ‚</option>
            </select>
            <div class="chips" aria-hidden="true">
              <span class="chip" data-level="1F" id="t_chip_ground">åœ°é¢</span>
              <span class="chip" data-level="B1" id="t_chip_b1">åœ°ä¸‹</span>
              <span class="chip" data-level="2F" id="t_chip_up">æ¨“ä¸Š</span>
            </div>
          </div>
          <div>
            <label for="floor_hint" id="t_lab_floor">ä½ç½®æè¿° <span style="color:#ef4444">*</span></label>
            <input id="floor_hint" name="floor_hint" type="text" placeholder="ä¾‹ï¼šå—æ£Ÿ 2F é é›»æ¢¯ã€B1 è¶…å•†å¾Œæ–¹ã€æˆ¶å¤–è¥¿å´æ¶¼äº­æ—" required />
            <div class="hint" id="t_hint_floor">è«‹æä¾›åˆ°é”æŒ‡å¼•ï¼šé è¿‘å“ªå€‹åº—/é›»æ¢¯/æ¨“æ¢¯/å‡ºå…¥å£ï¼Œæˆ–ã€Œåœ°ä¸‹/åœ°é¢/æ¨“ä¸Šã€ã€‚</div>
          </div>
        </div>

        <!-- ğŸšª å…¥å£/å°å¼• & é™åˆ¶ -->
        <label for="entrance_hint" id="t_lab_entr">å…¥å£/å°å¼•ï¼ˆé¸å¡«ï¼‰</label>
        <textarea id="entrance_hint" name="entrance_hint" placeholder="ä¾‹ï¼šå¾ä¸­åº­é›»æ‰¶æ¢¯ä¸Š 2F å·¦è½‰ 30 å…¬å°ºï¼›æ·é‹ X å‡ºå£å‡ºç«™å³è½‰ç›´èµ°ã€‚"></textarea>

        <div class="row two">
          <div>
            <label for="access_note" id="t_lab_access">æ˜¯å¦éœ€å¯†ç¢¼/åº—å“¡ï¼ˆé¸å¡«ï¼‰</label>
            <input id="access_note" name="access_note" type="text" placeholder="ä¾‹ï¼šéœ€åº—å“¡é–‹é–€ / æ«ƒå°ç´¢å–å¯†ç¢¼ 1024" />
          </div>
          <div>
            <label for="open_hours" id="t_lab_hours">é–‹æ”¾æ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
            <input id="open_hours" name="open_hours" type="text" placeholder="ä¾‹ï¼šæ¯æ—¥ 07:00â€“22:00 / é€±ä¸€å…¬ä¼‘" />
          </div>
        </div>

        <button type="submit" id="submitBtn">é€å‡º</button>
        <div id="msg" class="msg"></div>

        <div class="footer-note" id="t_footer">
          é€å‡ºå¾Œæœƒå¯«å…¥ä¸»è³‡æ–™ã€‚è‹¥æä¾› lat/lon æœƒç›´æ¥ä½¿ç”¨åº§æ¨™ï¼Œå¦å‰‡ä»¥åœ°å€è½‰æ›ã€‚<br/>
          å»ºè­°ç›¡é‡å¡«å¯«ã€Œæ¨“å±¤/ä½ç½®æè¿°ã€èˆ‡ã€Œå…¥å£/å°å¼•ã€ï¼Œèƒ½è®“ä½¿ç”¨è€…æ›´å¿«æ‰¾åˆ°å»æ‰€ã€‚
        </div>
      </form>
    </div>
  </div>

  <script>
    /** ===== i18n ===== */
    const I18N = {
      zh: {
        title: "æ–°å¢å»æ‰€",
        sub: "è«‹ç›¡é‡æä¾›æ¨“å±¤èˆ‡å…¥å£æç¤ºï¼Œèƒ½å¤§å¹…é™ä½ä½¿ç”¨è€…è¿·è·¯é¢¨éšªã€‚",
        lab_name: "å»æ‰€åç¨±",
        ph_name: "ä¾‹å¦‚ï¼šäº”å¸¸å…¬åœ’ å…¬å» / XXå•†å ´ å—æ£Ÿ 2F å»æ‰€",
        hint_name: "å»ºç¯‰ç‰©å…§è«‹å¯«åˆ°é¤¨åˆ¥/ç¿¼/å€åŸŸï¼Œä¾‹ï¼šAé¤¨ å—æ£Ÿ 2F å»æ‰€ã€‚",
        lab_uid: "ä½ çš„ LINE ID",
        hint_uid: "ç³»çµ±æœƒè‡ªå‹•å¸¶å…¥ä½ çš„ LINE UIDã€‚",
        lab_addr: "åœ°å€",
        ph_addr: "è«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼Œä¾‹å¦‚ï¼šæ–°åŒ—å¸‚ ä¸‰é‡å€ äº”è¯è¡— 7å·· 30è™Ÿ",
        hint_addr: "è‹¥å‰›åœ¨ LINE å‚³äº†ä½ç½®ï¼Œé€™è£¡æœƒè‡ªå‹•å¸¶å…¥ OSM å‹å–„åœ°å€ï¼›ä¸æ˜¯è¦æ–°å¢æ­¤åœ°é»å°±ç›´æ¥ä¿®æ”¹æˆ–åˆªé™¤å³å¯ã€‚",
        lab_lat: "ç·¯åº¦ (lat)",
        lab_lon: "ç¶“åº¦ (lon)",
        btn_geo: "ç”¨æˆ‘ç¾åœ¨çš„ä½ç½®",
        map_preview: "Google åœ°åœ–é è¦½",
        map_note: "ï¼ˆæœƒä»¥ lat/lon æˆ–åœ°å€é–‹å•Ÿï¼‰",
        level: "æ¨“å±¤",
        opt_level0: "â€” é¸æ“‡æ¨“å±¤ / æˆ¶å¤– â€”",
        opt_outdoor: "æˆ¶å¤–ï¼ˆç„¡å»ºç¯‰ï¼‰",
        opt_1f: "1Fï¼ˆåœ°é¢ï¼‰",
        opt_5p: "5F ä»¥ä¸Š",
        opt_roof: "å±‹é ‚",
        chip_ground: "åœ°é¢",
        chip_b1: "åœ°ä¸‹",
        chip_up: "æ¨“ä¸Š",
        lab_floor: "ä½ç½®æè¿°",
        ph_floor: "ä¾‹ï¼šå—æ£Ÿ 2F é é›»æ¢¯ã€B1 è¶…å•†å¾Œæ–¹ã€æˆ¶å¤–è¥¿å´æ¶¼äº­æ—",
        hint_floor: "è«‹æä¾›åˆ°é”æŒ‡å¼•ï¼šé è¿‘å“ªå€‹åº—/é›»æ¢¯/æ¨“æ¢¯/å‡ºå…¥å£ï¼Œæˆ–ã€Œåœ°ä¸‹/åœ°é¢/æ¨“ä¸Šã€ã€‚",
        lab_entr: "å…¥å£/å°å¼•ï¼ˆé¸å¡«ï¼‰",
        ph_entr: "ä¾‹ï¼šå¾ä¸­åº­é›»æ‰¶æ¢¯ä¸Š 2F å·¦è½‰ 30 å…¬å°ºï¼›æ·é‹ X å‡ºå£å‡ºç«™å³è½‰ç›´èµ°ã€‚",
        lab_access: "æ˜¯å¦éœ€å¯†ç¢¼/åº—å“¡ï¼ˆé¸å¡«ï¼‰",
        ph_access: "ä¾‹ï¼šéœ€åº—å“¡é–‹é–€ / æ«ƒå°ç´¢å–å¯†ç¢¼ 1024",
        lab_hours: "é–‹æ”¾æ™‚é–“ï¼ˆé¸å¡«ï¼‰",
        ph_hours: "ä¾‹ï¼šæ¯æ—¥ 07:00â€“22:00 / é€±ä¸€å…¬ä¼‘",
        submit: "é€å‡º",
        submitting: "é€å‡ºä¸­â€¦",
        ok_added: "âœ… å·²æ–°å¢ï¼Œæ„Ÿè¬è£œé»ï¼",
        err_need_name_addr: "è«‹å…ˆå¡«å¯«ã€å»æ‰€åç¨±ã€èˆ‡ã€åœ°å€ã€",
        err_floor_len: "è«‹è£œå……æ›´æ¸…æ¥šçš„ã€ä½ç½®æè¿°ã€ï¼ˆè‡³å°‘ 4 å€‹å­—ï¼‰",
        geo_unsup: "æ­¤è£ç½®ä¸æ”¯æ´å®šä½",
        geo_ok: "å·²å¸¶å…¥ç›®å‰åº§æ¨™",
        geo_fail: "å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–è¨Šè™Ÿ",
        fail_later: "æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦",
        net_err: "ç¶²è·¯æˆ–ä¼ºæœå™¨ç•°å¸¸ï¼Œè«‹ç¨å¾Œé‡è©¦",
        footer: "é€å‡ºå¾Œæœƒå¯«å…¥ä¸»è³‡æ–™ã€‚è‹¥æä¾› lat/lon æœƒç›´æ¥ä½¿ç”¨åº§æ¨™ï¼Œå¦å‰‡ä»¥åœ°å€è½‰æ›ã€‚<br/>å»ºè­°ç›¡é‡å¡«å¯«ã€Œæ¨“å±¤/ä½ç½®æè¿°ã€èˆ‡ã€Œå…¥å£/å°å¼•ã€ï¼Œèƒ½è®“ä½¿ç”¨è€…æ›´å¿«æ‰¾åˆ°å»æ‰€ã€‚"
      },
      en: {
        title: "Add a Restroom",
        sub: "Please provide floor and entrance hints to help others find it quickly.",
        lab_name: "Restroom name",
        ph_name: "e.g., Wuchang Park Public Restroom / Mall South Wing 2F Restroom",
        hint_name: "For buildings, include wing/area and floor, e.g., Building A South Wing 2F.",
        lab_uid: "Your LINE ID",
        hint_uid: "Your LINE UID will be filled automatically.",
        lab_addr: "Address",
        ph_addr: "Enter full address, e.g., No. 30, Ln. 7, Wuhua St., Sanchong Dist., New Taipei City",
        hint_addr: "If you just shared a location in LINE, we may prefill a friendly OSM address. Edit or clear it if itâ€™s not the same place.",
        lab_lat: "Latitude (lat)",
        lab_lon: "Longitude (lon)",
        btn_geo: "Use my location",
        map_preview: "Open in Google Maps",
        map_note: "(Opens by lat/lon or address)",
        level: "Floor",
        opt_level0: "â€” Choose floor / outdoors â€”",
        opt_outdoor: "Outdoors (no building)",
        opt_1f: "1F (ground)",
        opt_5p: "5F+",
        opt_roof: "Rooftop",
        chip_ground: "Ground",
        chip_b1: "Basement",
        chip_up: "Upstairs",
        lab_floor: "Location description",
        ph_floor: "e.g., South Wing 2F near elevator; B1 behind convenience store; outdoor west pavilion",
        hint_floor: "Provide guidance: near which shop/elevator/stairs/entrance, or basement/ground/upstairs.",
        lab_entr: "Entrance / directions (optional)",
        ph_entr: "e.g., From atrium escalator to 2F, turn left 30m; Exit X then turn right and walk straight.",
        lab_access: "Access note (optional)",
        ph_access: "e.g., Ask staff / Code 1024 at counter",
        lab_hours: "Open hours (optional)",
        ph_hours: "e.g., Daily 07:00â€“22:00 / Closed on Mondays",
        submit: "Submit",
        submitting: "Submittingâ€¦",
        ok_added: "âœ… Added. Thanks!",
        err_need_name_addr: "Please fill in â€œRestroom nameâ€ and â€œAddressâ€.",
        err_floor_len: "Please provide a clearer location description (at least 4 characters).",
        geo_unsup: "Geolocation is not supported on this device.",
        geo_ok: "Coordinates filled in.",
        geo_fail: "Location failed. Please check permissions or signal.",
        fail_later: "Failed to add. Please try again later.",
        net_err: "Network/server error. Please try again later.",
        footer: "Submitted entries are saved to the main dataset. If lat/lon is provided, we use coordinates directly; otherwise we geocode the address.<br/>Strongly recommended: fill in â€œFloor / location descriptionâ€ and â€œEntrance / directionsâ€."
      }
    };

    function normLang(x){
      x = (x || "").toLowerCase();
      if (x.startsWith("en")) return "en";
      return "zh";
    }
    function getLang(){
      const p = new URLSearchParams(location.search);
      const q = p.get("lang");
      if (q) return normLang(q);
      try { if (window.liff && typeof liff.getLanguage === "function") return normLang(liff.getLanguage()); } catch {}
      return normLang(navigator.language || "zh");
    }
    const LANG = getLang();
    const T = I18N[LANG] || I18N.zh;

    document.documentElement.lang = (LANG === "en") ? "en" : "zh-Hant";
    document.title = T.title;

    // å¥—ç”¨éœæ…‹æ–‡å­—ï¼ˆlabel/placeholder/hint/buttonï¼‰
    const setText = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
    const setPH = (id, val)=>{ const el=document.getElementById(id); if(el) el.placeholder = val; };

    setText("t_title", T.title);
    setText("t_h1", T.title);
    setText("t_sub", T.sub);

    setText("t_lab_name", T.lab_name + " ");
    setPH("name", T.ph_name);
    setText("t_hint_name", T.hint_name);

    setText("t_lab_uid", T.lab_uid);
    setText("t_hint_uid", T.hint_uid);

    setText("t_lab_addr", T.lab_addr + " ");
    setPH("address", T.ph_addr);
    setText("t_hint_addr", T.hint_addr);

    setText("t_lab_lat", T.lab_lat);
    setText("t_lab_lon", T.lab_lon);

    setText("btnGeo", T.btn_geo);
    setText("mapPreview", T.map_preview);
    setText("t_map_note", T.map_note);

    setText("t_lab_level", T.level);
    setText("t_opt_level0", T.opt_level0);
    setText("t_opt_outdoor", T.opt_outdoor);
    setText("t_opt_1f", T.opt_1f);
    setText("t_opt_5p", T.opt_5p);
    setText("t_opt_roof", T.opt_roof);
    setText("t_chip_ground", T.chip_ground);
    setText("t_chip_b1", T.chip_b1);
    setText("t_chip_up", T.chip_up);

    setText("t_lab_floor", T.lab_floor + " ");
    setPH("floor_hint", T.ph_floor);
    setText("t_hint_floor", T.hint_floor);

    setText("t_lab_entr", T.lab_entr);
    setPH("entrance_hint", T.ph_entr);

    setText("t_lab_access", T.lab_access);
    setPH("access_note", T.ph_access);

    setText("t_lab_hours", T.lab_hours);
    setPH("open_hours", T.ph_hours);

    setText("submitBtn", T.submit);
    document.getElementById("t_footer").innerHTML = T.footer;

    /** ===== original logic (with lang) ===== */
    (function () {
      const $ = (sel) => document.querySelector(sel);
      const form = $("#toiletForm");
      const btn = $("#submitBtn");
      const msg = $("#msg");
      const uidInput = $("#user_id");
      const addrInput = $("#address");
      const latInput = $("#lat");
      const lonInput = $("#lon");
      const levelSel = $("#level");
      const mapPreview = $("#mapPreview");

      // è‡ªå‹•å¡«å…¥ LINE UIDï¼ˆè‹¥å¾Œç«¯æ²’å¸¶ uidï¼Œå°± fallback ç‚º "web"ï¼‰
      if (!uidInput.value) { uidInput.value = "web"; }

      // å¿«é€Ÿæ¨“å±¤ Chips
      document.querySelectorAll(".chip").forEach(ch => {
        ch.addEventListener("click", () => {
          levelSel.value = ch.dataset.level || "";
        });
      });

      // æ›´æ–°åœ°åœ–é è¦½é€£çµ
      function updateMapPreview() {
        const lat = (latInput.value || "").trim();
        const lon = (lonInput.value || "").trim();
        if (lat && lon) {
          mapPreview.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;
        } else {
          const q = (addrInput.value || "").trim();
          mapPreview.href = q ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}` : "#";
        }
      }
      [latInput, lonInput, addrInput].forEach(el => el.addEventListener("input", updateMapPreview));
      updateMapPreview();

      // ä¸€éµæŠ“ç›®å‰åº§æ¨™
      $("#btnGeo").addEventListener("click", () => {
        if (!navigator.geolocation) {
          return showErr(T.geo_unsup);
        }
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            latInput.value = pos.coords.latitude.toFixed(6);
            lonInput.value = pos.coords.longitude.toFixed(6);
            showOk(T.geo_ok);
            btn.disabled = false;
            updateMapPreview();
          },
          (err) => {
            showErr(T.geo_fail);
            btn.disabled = false;
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      // è‹¥æ²’æœ‰å¾Œç«¯é å¡«åœ°å€ï¼Œä½† URL ä¸Šæœ‰ lat/lonï¼Œå°±ç”¨ OSM Reverse ä¾†è£œåœ°å€
      (async function maybeReverseGeocode() {
        const hasAddress = (addrInput.value || "").trim().length > 0;
        const lat = (latInput.value || "").trim() || new URLSearchParams(location.search).get("lat");
        const lon = (lonInput.value || "").trim() || new URLSearchParams(location.search).get("lon");
        if (hasAddress || !lat || !lon) return;

        latInput.value = lat;
        lonInput.value = lon;

        try {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1`;
          const res = await fetch(url, { headers: { "Accept": "application/json" } });
          if (!res.ok) throw new Error("reverse geocode failed");
          const data = await res.json();

          const a = data.address || {};
          const pretty =
            [
              a.country || "",
              a.state || a.region || "",
              a.city || a.town || a.village || a.county || "",
              a.suburb || a.neighbourhood || "",
              a.road || "",
              a.house_number || "",
              a.postcode || ""
            ]
            .filter(Boolean)
            .join(" ")
            .replace(/\s+/g, " ")
            .trim();

          addrInput.value = pretty || (data.display_name || "");
          updateMapPreview();
        } catch (e) {
          console.warn("OSM reverse geocode failed", e);
        }
      })();

      // è¡¨å–®é€å‡º
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.className = "msg"; msg.style.display = "none"; msg.textContent = "";

        const name = $("#name").value.trim();
        const address = addrInput.value.trim();
        const user_id = uidInput.value.trim() || "web";
        const lat = (latInput.value || "").trim();
        const lon = (lonInput.value || "").trim();
        const level = (levelSel.value || "").trim();
        const floor_hint = ($("#floor_hint").value || "").trim();
        const entrance_hint = ($("#entrance_hint").value || "").trim();
        const access_note = ($("#access_note").value || "").trim();
        const open_hours = ($("#open_hours").value || "").trim();

        if (!name || !address) {
          return showErr(T.err_need_name_addr);
        }
        // ä½ç½®æè¿°å¼·åˆ¶è‡³å°‘ 4 å­—ï¼Œé¿å…ç©ºæ³›
        if (floor_hint.length < 4) {
          return showErr(T.err_floor_len);
        }

        btn.disabled = true; btn.textContent = T.submitting;

        try {
          const payload = { lang: LANG, user_id, name, address, floor_hint, level, entrance_hint, access_note, open_hours };
          if (lat && lon) { payload.lat = lat; payload.lon = lon; }

          const res = await fetch("/submit_toilet", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));

          if (res.ok && data && data.success) {
            showOk(data.message || T.ok_added);
            $("#name").value = "";
            // ä¸æ¸…ç©ºåœ°å€ï¼Œæ–¹ä¾¿é€£çºŒè£œé»åŒå€åŸŸï¼›æ¸…ç©ºå…¶ä»–æŒ‡å¼•æ¬„ä½
            $("#floor_hint").value = "";
            $("#entrance_hint").value = "";
            $("#access_note").value = "";
            $("#open_hours").value = "";
            levelSel.value = "";
          } else {
            showErr((data && data.message) || T.fail_later);
          }
        } catch (err) {
          showErr(T.net_err);
        } finally {
          btn.disabled = false; btn.textContent = T.submit;
        }
      });

      function showOk(text) {
        msg.className = "msg ok";
        msg.textContent = text;
        msg.style.display = "block";
      }
      function showErr(text) {
        msg.className = "msg err";
        msg.textContent = (LANG === "en" ? "âŒ " : "âŒ ") + text;
        msg.style.display = "block";
      }
    })();
  </script>
</body>
</html>
