<script>
(function () {
  const $ = (sel) => document.querySelector(sel);
  const form = $("#toiletForm");
  const btn = $("#submitBtn");
  const msg = $("#msg");
  const uidInput = $("#user_id");
  const uidBlock = document.querySelector("[data-userid-block]");
  const addrInput = $("#address");
  const latInput = $("#lat");
  const lonInput = $("#lon");

  // ==== A) 自動帶入 userId ====
  const LIFF_ID = "2007674330-0XpoR2dW"; // 你的 LIFF ID

  async function autofillUserId() {
    // 1) 先吃 URL 的 uid
    const qs = new URLSearchParams(location.search);
    const urlUid = qs.get("uid");
    if (urlUid) {
      uidInput.value = urlUid;
      if (uidBlock) uidBlock.style.display = "none"; // 隱藏整塊
      return;
    }

    // 2) 沒有 uid 參數，再嘗試 LIFF（若在 LINE 內）
    if (window.liff) {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          // 若需要可自動登入；這頁多半在外部瀏覽器，不一定要叫 login
          // liff.login({ redirectUri: location.href });
        } else {
          const profile = await liff.getProfile();
          if (profile && profile.userId) {
            uidInput.value = profile.userId;
            if (uidBlock) uidBlock.style.display = "none";
            return;
          }
        }
      } catch (e) {
        console.warn("LIFF 取 userId 失敗", e);
      }
    }

    // 3) 最後才用 localStorage 備援（保留你原本的行為）
    try {
      const saved = localStorage.getItem("toilet_uid");
      if (saved && !uidInput.value) uidInput.value = saved;
    } catch {}
  }
  autofillUserId();

  // ==== B) 若沒有後端預填地址，但 URL 上有 lat/lon，就反查地址 ====
  (async function maybeReverseGeocode() {
    const hasAddress = (addrInput.value || "").trim().length > 0;
    const lat = (latInput.value || "").trim() || new URLSearchParams(location.search).get("lat");
    const lon = (lonInput.value || "").trim() || new URLSearchParams(location.search).get("lon");
    if (hasAddress || !lat || !lon) return;

    latInput.value = lat;
    lonInput.value = lon;

    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("reverse geocode 失敗");
      const data = await res.json();
      const a = data.address || {};
      const pretty = [
        a.country || "", a.state || a.region || "",
        a.city || a.town || a.village || a.county || "",
        a.suburb || a.neighbourhood || "", a.road || "",
        a.house_number || "", a.postcode || ""
      ].filter(Boolean).join(" ").replace(/\s+/g, " ").trim();
      addrInput.value = pretty || (data.display_name || "");
    } catch (e) {
      console.warn("OSM reverse geocode 失敗", e);
    }
  })();

  // ==== C) 送出 ====
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.className = "msg"; msg.style.display = "none"; msg.textContent = "";

    const name = $("#name").value.trim();
    const address = addrInput.value.trim();
    let user_id = (uidInput.value || "").trim() || "web";   // 自動帶入後就有值了
    const lat = (latInput.value || "").trim();
    const lon = (lonInput.value || "").trim();

    if (!name || !address) {
      return showErr("請先填寫『廁所名稱』與『地址』");
    }

    // 記住 user_id（即使是自動填的，也存一下）
    try { localStorage.setItem("toilet_uid", user_id); } catch {}

    btn.disabled = true; btn.textContent = "送出中…";
    try {
      const payload = { user_id, name, address };
      if (lat && lon) { payload.lat = lat; payload.lon = lon; }

      const res = await fetch("/submit_toilet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));

      if (res.ok && data && data.success) {
        showOk(data.message || "✅ 已新增，感謝補點！");
        $("#name").value = "";
      } else {
        showErr((data && data.message) || "新增失敗，請稍後再試");
      }
    } catch {
      showErr("網路或伺服器異常，請稍後重試");
    } finally {
      btn.disabled = false; btn.textContent = "送出";
    }
  });

  function showOk(text) { msg.className = "msg ok"; msg.textContent = text; msg.style.display = "block"; }
  function showErr(text) { msg.className = "msg err"; msg.textContent = "❌ " + text; msg.style.display = "block"; }
})();
</script>
