<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title id="t_title">AI å›é¥‹æ‘˜è¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 16px; line-height: 1.6; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 6px; text-decoration: none; border: 1px solid #007bff; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.23.0/sdk.js"></script>
</head>
<body>
  <h2 id="t_h2">AI å›é¥‹æ‘˜è¦</h2>
  <p id="t_p1">é€™æ˜¯æ ¹æ“šä½¿ç”¨è€…å°é€™é–“å»æ‰€çš„å›é¥‹ï¼Œç”± AI è‡ªå‹•æ•´ç†çš„æ‘˜è¦ã€‚</p>

  <div id="summary-card" class="card">
    <div id="status">è¼‰å…¥ä¸­â‹¯â‹¯</div>
    <pre id="summary-text" style="white-space: pre-wrap;"></pre>
  </div>

  <div class="card">
    <h3 id="t_h3">å¹«å¿™ç•™ä¸‹ä½ çš„å›é¥‹ ğŸ™Œ</h3>
    <p id="t_p2">å¦‚æœä½ å‰›å‰›æœ‰ä½¿ç”¨é€™é–“å»æ‰€ï¼Œå¯ä»¥é»ä¸‹é¢çš„æŒ‰éˆ•å¡«å¯«å›é¥‹ï¼Œè®“è³‡æ–™æ›´å®Œæ•´ã€‚</p>
    <a id="t_btn" href="{{ feedback_url }}" class="btn">å‰å¾€å›é¥‹è¡¨å–®</a>
  </div>

  <script>
    const I18N = {
      zh: {
        h2:"AI å›é¥‹æ‘˜è¦", p1:"é€™æ˜¯æ ¹æ“šä½¿ç”¨è€…å°é€™é–“å»æ‰€çš„å›é¥‹ï¼Œç”± AI è‡ªå‹•æ•´ç†çš„æ‘˜è¦ã€‚",
        h3:"å¹«å¿™ç•™ä¸‹ä½ çš„å›é¥‹ ğŸ™Œ", p2:"å¦‚æœä½ å‰›å‰›æœ‰ä½¿ç”¨é€™é–“å»æ‰€ï¼Œå¯ä»¥é»ä¸‹é¢çš„æŒ‰éˆ•å¡«å¯«å›é¥‹ï¼Œè®“è³‡æ–™æ›´å®Œæ•´ã€‚",
        btn:"å‰å¾€å›é¥‹è¡¨å–®", loading:"è¼‰å…¥ä¸­â‹¯â‹¯", failed:"è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
        no_data:"ç›®å‰é‚„æ²’æœ‰ä»»ä½•å›é¥‹è³‡æ–™ã€‚", no_summary:"ç›®å‰æ²’æœ‰å¯ç”¨çš„æ‘˜è¦å…§å®¹ã€‚", sys_err:"ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
      },
      en: {
        h2:"AI Feedback Summary", p1:"This is an AI-generated summary based on users' feedback for this restroom.",
        h3:"Leave your feedback ğŸ™Œ", p2:"If you just used this restroom, please submit feedback to improve the data.",
        btn:"Open feedback form", loading:"Loadingâ€¦", failed:"Failed to load. Please try again later.",
        no_data:"No feedback yet.", no_summary:"No summary available.", sys_err:"System error. Please try again later."
      }
    };
    const LIFF_ID = "{{ liff_id|default('', true) }}";

    function normLang(x){ x=(x||"").toLowerCase(); return x.startsWith("en")?"en":"zh"; }
    function getQueryLang(){ const p=new URLSearchParams(location.search); const q=p.get("lang"); return q?normLang(q):""; }
    function ensureLangInUrl(lang){
      const p=new URLSearchParams(location.search);
      if(p.get("lang")) return;
      p.set("lang", lang);
      history.replaceState({}, "", location.pathname + "?" + p.toString());
    }
    async function initLiffBestEffort(){
      if(!window.liff || !LIFF_ID) return false;
      try{ await liff.init({liffId:LIFF_ID}); return true; }catch{ return false; }
    }
    async function detectLangAfterInit(){
      const q=getQueryLang(); if(q) return q;
      try{ if(window.liff && typeof liff.getLanguage==="function") return normLang(liff.getLanguage()); }catch{}
      return normLang(navigator.language||"zh");
    }

    (async function boot(){
      await initLiffBestEffort();
      const LANG = await detectLangAfterInit();
      ensureLangInUrl(LANG);
      const T = I18N[LANG] || I18N.zh;

      document.documentElement.lang = (LANG==="en")?"en":"zh-Hant";
      document.title = T.h2;

      const setText=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=v;};
      setText("t_title", T.h2);
      setText("t_h2", T.h2);
      setText("t_p1", T.p1);
      setText("t_h3", T.h3);
      setText("t_p2", T.p2);
      setText("t_btn", T.btn);
      setText("status", T.loading);

      // âœ… feedback_url ä¹Ÿè£œ langï¼ˆé¿å…è·³ä¸‹ä¸€é åˆè®Šä¸­æ–‡ï¼‰
      try{
        const a=document.getElementById("t_btn");
        const u=new URL(a.getAttribute("href"), location.origin);
        if(!u.searchParams.get("lang")) u.searchParams.set("lang", LANG);
        a.setAttribute("href", u.pathname + "?" + u.searchParams.toString());
      }catch{}

      // data fetch
      let apiUrl = "{{ api_url }}";
      try {
        const u = new URL(apiUrl, location.origin);
        u.searchParams.set("lang", LANG);
        apiUrl = u.toString();
      } catch {}

      fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
          const statusEl = document.getElementById("status");
          const textEl   = document.getElementById("summary-text");

          if (!data.success) { statusEl.textContent = T.failed; return; }

          if (!data.has_data) {
            statusEl.textContent = "";
            textEl.textContent = data.summary || T.no_data;
            return;
          }

          statusEl.textContent = "";
          textEl.textContent = data.summary || T.no_summary;
        })
        .catch(err => {
          console.error(err);
          document.getElementById("status").textContent = T.sys_err;
        });
    })();
  </script>
</body>
</html>
