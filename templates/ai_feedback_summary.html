<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title id="t_title">AI å›é¥‹æ‘˜è¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      line-height: 1.6;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .btn {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      border: 1px solid #007bff;
    }
  </style>
</head>
<body>
  <h2 id="t_h2">AI å›é¥‹æ‘˜è¦</h2>
  <p id="t_p1">é€™æ˜¯æ ¹æ“šä½¿ç”¨è€…å°é€™é–“å»æ‰€çš„å›é¥‹ï¼Œç”± AI è‡ªå‹•æ•´ç†çš„æ‘˜è¦ã€‚</p>

  <div id="summary-card" class="card">
    <div id="status">è¼‰å…¥ä¸­â‹¯â‹¯</div>
    <pre id="summary-text" style="white-space: pre-wrap;"></pre>
  </div>

  <div class="card">
    <h3 id="t_h3">å¹«å¿™ç•™ä¸‹ä½ çš„å›é¥‹ ğŸ™Œ</h3>
    <p id="t_p2">å¦‚æœä½ å‰›å‰›æœ‰ä½¿ç”¨é€™é–“å»æ‰€ï¼Œå¯ä»¥é»ä¸‹é¢çš„æŒ‰éˆ•å¡«å¯«å›é¥‹ï¼Œè®“è³‡æ–™æ›´å®Œæ•´ã€‚</p>
    <a id="t_btn" href="{{ feedback_url }}" class="btn">å‰å¾€å›é¥‹è¡¨å–®</a>
  </div>

  <script>
    /** ===== i18n ===== */
    const I18N = {
      zh: {
        h2: "AI å›é¥‹æ‘˜è¦",
        p1: "é€™æ˜¯æ ¹æ“šä½¿ç”¨è€…å°é€™é–“å»æ‰€çš„å›é¥‹ï¼Œç”± AI è‡ªå‹•æ•´ç†çš„æ‘˜è¦ã€‚",
        h3: "å¹«å¿™ç•™ä¸‹ä½ çš„å›é¥‹ ğŸ™Œ",
        p2: "å¦‚æœä½ å‰›å‰›æœ‰ä½¿ç”¨é€™é–“å»æ‰€ï¼Œå¯ä»¥é»ä¸‹é¢çš„æŒ‰éˆ•å¡«å¯«å›é¥‹ï¼Œè®“è³‡æ–™æ›´å®Œæ•´ã€‚",
        btn: "å‰å¾€å›é¥‹è¡¨å–®",
        loading: "è¼‰å…¥ä¸­â‹¯â‹¯",
        failed: "è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
        no_data: "ç›®å‰é‚„æ²’æœ‰ä»»ä½•å›é¥‹è³‡æ–™ã€‚",
        no_summary: "ç›®å‰æ²’æœ‰å¯ç”¨çš„æ‘˜è¦å…§å®¹ã€‚",
        sys_err: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
      },
      en: {
        h2: "AI Feedback Summary",
        p1: "This is an AI-generated summary based on users' feedback for this restroom.",
        h3: "Leave your feedback ğŸ™Œ",
        p2: "If you just used this restroom, please submit feedback to improve the data.",
        btn: "Open feedback form",
        loading: "Loadingâ€¦",
        failed: "Failed to load. Please try again later.",
        no_data: "No feedback yet.",
        no_summary: "No summary available.",
        sys_err: "System error. Please try again later."
      }
    };

    function normLang(x){
  x = (x || "").toLowerCase();
  if (x.startsWith("zh")) return "zh";
  return "en";
}
function getLang(){
      const p = new URLSearchParams(location.search);
      const q = p.get("lang");
      if (q) return normLang(q);
      return normLang(navigator.language || "zh");
    }
    const LANG = getLang();
    const T = I18N[LANG] || I18N.zh;

    document.documentElement.lang = (LANG === "en") ? "en" : "zh-Hant";
    document.title = T.h2;

    // å¥—ç”¨éœæ…‹æ–‡å­—
    const setText = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
    setText("t_title", T.h2);
    setText("t_h2", T.h2);
    setText("t_p1", T.p1);
    setText("t_h3", T.h3);
    setText("t_p2", T.p2);
    setText("t_btn", T.btn);
    setText("status", T.loading);

    /** ===== data fetch ===== */
    let apiUrl = "{{ api_url }}";
    try {
      // è‹¥ apiUrl æ²’å¸¶ langï¼Œå°±è£œä¸Š
      const u = new URL(apiUrl, location.origin);
      if (!u.searchParams.get("lang")) u.searchParams.set("lang", LANG);
      apiUrl = u.toString();
    } catch {}

    fetch(apiUrl)
      .then(r => r.json())
      .then(data => {
        const statusEl = document.getElementById("status");
        const textEl   = document.getElementById("summary-text");

        if (!data.success) {
          statusEl.textContent = T.failed;
          return;
        }

        // has_data = False ä»£è¡¨æ²’æœ‰ä»»ä½•å›é¥‹ â†’ é¡¯ç¤ºæ–‡å­—å°±å¥½ï¼Œä¸å‘¼å« AI
        if (!data.has_data) {
          statusEl.textContent = "";
          textEl.textContent = data.summary || T.no_data;
          return;
        }

        statusEl.textContent = "";
        textEl.textContent = data.summary || T.no_summary;
      })
      .catch(err => {
        console.error(err);
        document.getElementById("status").textContent = T.sys_err;
      });
  </script>
</body>
</html>
