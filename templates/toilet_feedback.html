<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>{{ toilet_name }} 回饋</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2C3E50; margin-bottom: 6px; }
        .addr { color: #666; margin-top: 0; }
        .cleanliness-score { background-color: #e0f7fa; padding: 10px; border-left: 5px solid #00acc1; margin: 15px 0; font-weight: bold; }
        .nowcast-box { background:#fff7e6; padding:10px; border-left:5px solid #ff9800; margin:12px 0; }
        .summary-box { background: #fff; border-radius: 8px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); white-space: pre-line; }
        .section-title { margin-top: 24px; font-weight: bold; color: #2C3E50; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: #fff; margin: 10px 0; padding: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .toggle-button { background: none; border: none; color: #007BFF; cursor: pointer; font-size: 1em; margin-bottom: 10px; }
        .comment { font-style: italic; color: #888; }
        .collapsed { display: none; }
        .no-feedback { color: #999; }
        #cleanlinessChart { width: 100%; height: 300px; margin-top: 14px; }
        .muted { color:#888; font-size: 12px; }
    </style>
</head>
<body>
    <h2>{{ toilet_name }}</h2>
    {% if address %}<p class="addr">{{ address }}</p>{% endif %}

    <div class="cleanliness-score">
        平均預測清潔分數(最高5分)：<span id="avgPredScore">未預測</span>
    </div>

    <!-- ✅ 新增：即時清潔指數 Nowcast + 95% CI -->
    <div class="nowcast-box">
        <div id="nowcastText">即時清潔指數載入中…</div>
        <div class="muted">* 以上為最近回饋的即時估計，括號為 95% 信賴區間；n 為納入計算的筆數</div>
    </div>

    {% if summary %}
      <div class="summary-box">{{ summary }}</div>
    {% endif %}

    <div class="section-title">清潔度趨勢</div>
    <canvas id="cleanlinessChart"></canvas>

    <div class="section-title">使用者回饋</div>
    {% if feedbacks and feedbacks|length > 0 %}
        {% if feedbacks|length > 1 %}
            <button class="toggle-button" id="toggleBtn">▶️ 展開其他 {{ feedbacks|length - 1 }} 筆使用者回饋</button>
        {% endif %}
        <ul id="feedbackList">
            <li>
                <p><strong>🌟 評分:</strong> {{ feedbacks[0].rating }} ｜ 
                   <strong>🧻 衛生紙:</strong> {{ feedbacks[0].toilet_paper }} ｜ 
                   <strong>♿ 無障礙設施:</strong> {{ feedbacks[0].accessibility }} ｜ 
                   <strong>🕒 使用時間:</strong> {{ feedbacks[0].time_of_use or '未填寫' }}</p>
                <p class="comment">
                    <strong>💬 留言:</strong>
                    {% if feedbacks[0].comment and feedbacks[0].comment.strip() %}
                        {{ feedbacks[0].comment }}
                    {% else %}
                        （無留言）
                    {% endif %}
                </p>
                <p style="color:#999;">📅 {{ feedbacks[0].created_at }}</p>
            </li>

            {% for c in feedbacks[1:] %}
                <li class="collapsed">
                    <p><strong>🌟 評分:</strong> {{ c.rating }} ｜ 
                       <strong>🧻 衛生紙:</strong> {{ c.toilet_paper }} ｜ 
                       <strong>♿ 無障礙設施:</strong> {{ c.accessibility }} ｜ 
                       <strong>🕒 使用時間:</strong> {{ c.time_of_use or '未填寫' }}</p>
                    <p class="comment">
                        <strong>💬 留言:</strong>
                        {% if c.comment and c.comment.strip() %}
                            {{ c.comment }}
                        {% else %}
                            （無留言）
                        {% endif %}
                    </p>
                    <p style="color:#999;">📅 {{ c.created_at }}</p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <ul><li class="no-feedback">（目前尚無任何回饋）</li></ul>
    {% endif %}

    <!-- 先載入 Chart.js 再畫圖 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 展開更多
        const btn = document.getElementById('toggleBtn');
        if (btn) {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.collapsed').forEach(li => li.classList.remove('collapsed'));
                btn.style.display = 'none';
            });
        }

        // 取得座標：先試模板變數，失敗則從網址 /toilet_feedback_by_coord/<lat>/<lon> 解析
        function getLatLon() {
            let lat = "{{ lat|default('', true) }}";
            let lon = "{{ lon|default('', true) }}";
            if (lat && lon) return {lat, lon};

            // 從 URL path 抓
            const m = decodeURIComponent(location.pathname).match(/\/toilet_feedback_by_coord\/([^/]+)\/([^/]+)/);
            if (m && m[1] && m[2]) return { lat: m[1], lon: m[2] };

            // 從 address 嘗試 "lat,lon"
            const addrNode = document.querySelector('.addr');
            if (addrNode) {
                const m2 = (addrNode.textContent || '').match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
                if (m2) return { lat: m2[1], lon: m2[2] };
            }
            return {lat:'', lon:''};
        }

        (function drawTrendAndAvg() {
            const { lat, lon } = getLatLon();
            if (!lat || !lon) return;

            // 1) 趨勢＆平均（沿用你原本的做法）
            fetch(`/get_clean_trend_by_coord/${lat}/${lon}`)
              .then(r => r.json())
              .then(data => {
                  const arr = (data && data.data) ? data.data : [];
                  const ctx = document.getElementById('cleanlinessChart').getContext('2d');

                  // 計算平均並顯示在藍色盒
                  const avgNode = document.getElementById('avgPredScore');
                  if (arr.length > 0) {
                      const avg = (arr.reduce((s,x)=>s + (Number(x.score)||0), 0) / arr.length).toFixed(2);
                      if (avgNode) avgNode.textContent = avg;
                  } else {
                      if (avgNode) avgNode.textContent = '未預測';
                  }

                  // 畫圖
                  new Chart(ctx, {
                      type: 'line',
                      data: {
                          labels: arr.map((_, i) => `#${i + 1}`),
                          datasets: [{
                              label: '清潔度預測',
                              data: arr.map(x => Number(x.score)||null),
                              borderColor: 'rgba(75, 192, 192, 1)',
                              fill: false,
                              tension: 0.3
                          }]
                      },
                      options: {
                          responsive: true,
                          scales: {
                              x: { title: { display: true, text: '回饋次數' } },
                              y: { min: 1, max: 5, title: { display: true, text: '清潔度' } }
                          }
                      }
                  });
              })
              .catch(err => {
                  console.error('取得趨勢資料失敗:', err);
              });

            // 2) ✅ Nowcast 即時清潔指數 + 95% CI
            fetch(`/get_nowcast_by_coord/${lat}/${lon}`)
              .then(r => r.json())
              .then(data => {
                  const box = document.getElementById('nowcastText');
                  if (!box) return;
                  if (!data || data.success === false || (data.n !== undefined && data.n === 0)) {
                      box.textContent = '即時清潔指數：尚無即時資料';
                      return;
                  }
                  const mean = (data.mean !== undefined) ? Number(data.mean).toFixed(2) : '—';
                  const lower = (data.lower !== undefined) ? Number(data.lower).toFixed(2) : '—';
                  const upper = (data.upper !== undefined) ? Number(data.upper).toFixed(2) : '—';
                  const n = (data.n !== undefined) ? data.n : 0;
                  box.textContent = `即時清潔指數：${mean} 分（95% CI：${lower}–${upper}，n=${n})`;
              })
              .catch(err => {
                  console.error('取得 Nowcast 失敗:', err);
                  const box = document.getElementById('nowcastText');
                  if (box) box.textContent = '即時清潔指數：載入失敗';
              });
        })();
    </script>
</body>
</html>
