<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>{{ toilet_name }} å›é¥‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2C3E50; margin-bottom: 6px; }
        .addr { color: #666; margin-top: 0; }
        .cleanliness-score { background-color: #e0f7fa; padding: 10px; border-left: 5px solid #00acc1; margin: 15px 0; font-weight: bold; }
        .nowcast-box { background:#fff7e6; padding:10px; border-left:5px solid #ff9800; margin:12px 0; }
        .summary-box { background: #fff; border-radius: 8px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); white-space: pre-line; }
        .section-title { margin-top: 24px; font-weight: bold; color: #2C3E50; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: #fff; margin: 10px 0; padding: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .toggle-button { background: none; border: none; color: #007BFF; cursor: pointer; font-size: 1em; margin-bottom: 10px; }
        .comment { font-style: italic; color: #888; }
        .collapsed { display: none; }
        .no-feedback { color: #999; }
        #cleanlinessChart { width: 100%; height: 300px; margin-top: 14px; }
        .muted { color:#888; font-size: 12px; }
    </style>
</head>
<body>
    <h2>{{ toilet_name }}</h2>
    {% if address %}<p class="addr">{{ address }}</p>{% endif %}

    <div class="cleanliness-score">
        å¹³å‡é æ¸¬æ¸…æ½”åˆ†æ•¸(æœ€é«˜5åˆ†)ï¼š<span id="avgPredScore">æœªé æ¸¬</span>
    </div>

    <!-- âœ… æ–°å¢ï¼šå³æ™‚æ¸…æ½”æŒ‡æ•¸ Nowcast + 95% CI -->
    <div class="nowcast-box">
        <div id="nowcastText">å³æ™‚æ¸…æ½”æŒ‡æ•¸è¼‰å…¥ä¸­â€¦</div>
        <div class="muted">* ä»¥ä¸Šç‚ºæœ€è¿‘å›é¥‹çš„å³æ™‚ä¼°è¨ˆï¼Œæ‹¬è™Ÿç‚º 95% ä¿¡è³´å€é–“ï¼›n ç‚ºç´å…¥è¨ˆç®—çš„ç­†æ•¸</div>
    </div>

    {% if summary %}
      <div class="summary-box">{{ summary }}</div>
    {% endif %}

    <div class="section-title">æ¸…æ½”åº¦è¶¨å‹¢</div>
    <canvas id="cleanlinessChart"></canvas>

    <div class="section-title">ä½¿ç”¨è€…å›é¥‹</div>
    {% if feedbacks and feedbacks|length > 0 %}
        {% if feedbacks|length > 1 %}
            <button class="toggle-button" id="toggleBtn">â–¶ï¸ å±•é–‹å…¶ä»– {{ feedbacks|length - 1 }} ç­†ä½¿ç”¨è€…å›é¥‹</button>
        {% endif %}
        <ul id="feedbackList">
            <li>
                <p><strong>ğŸŒŸ è©•åˆ†:</strong> {{ feedbacks[0].rating }} ï½œ 
                   <strong>ğŸ§» è¡›ç”Ÿç´™:</strong> {{ feedbacks[0].toilet_paper }} ï½œ 
                   <strong>â™¿ ç„¡éšœç¤™è¨­æ–½:</strong> {{ feedbacks[0].accessibility }} ï½œ 
                   <strong>ğŸ•’ ä½¿ç”¨æ™‚é–“:</strong> {{ feedbacks[0].time_of_use or 'æœªå¡«å¯«' }}</p>
                <p class="comment">
                    <strong>ğŸ’¬ ç•™è¨€:</strong>
                    {% if feedbacks[0].comment and feedbacks[0].comment.strip() %}
                        {{ feedbacks[0].comment }}
                    {% else %}
                        ï¼ˆç„¡ç•™è¨€ï¼‰
                    {% endif %}
                </p>
                <p style="color:#999;">ğŸ“… {{ feedbacks[0].created_at }}</p>
            </li>

            {% for c in feedbacks[1:] %}
                <li class="collapsed">
                    <p><strong>ğŸŒŸ è©•åˆ†:</strong> {{ c.rating }} ï½œ 
                       <strong>ğŸ§» è¡›ç”Ÿç´™:</strong> {{ c.toilet_paper }} ï½œ 
                       <strong>â™¿ ç„¡éšœç¤™è¨­æ–½:</strong> {{ c.accessibility }} ï½œ 
                       <strong>ğŸ•’ ä½¿ç”¨æ™‚é–“:</strong> {{ c.time_of_use or 'æœªå¡«å¯«' }}</p>
                    <p class="comment">
                        <strong>ğŸ’¬ ç•™è¨€:</strong>
                        {% if c.comment and c.comment.strip() %}
                            {{ c.comment }}
                        {% else %}
                            ï¼ˆç„¡ç•™è¨€ï¼‰
                        {% endif %}
                    </p>
                    <p style="color:#999;">ğŸ“… {{ c.created_at }}</p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <ul><li class="no-feedback">ï¼ˆç›®å‰å°šç„¡ä»»ä½•å›é¥‹ï¼‰</li></ul>
    {% endif %}

    <!-- å…ˆè¼‰å…¥ Chart.js å†ç•«åœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // å±•é–‹æ›´å¤š
        const btn = document.getElementById('toggleBtn');
        if (btn) {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.collapsed').forEach(li => li.classList.remove('collapsed'));
                btn.style.display = 'none';
            });
        }

        // å–å¾—åº§æ¨™ï¼šå…ˆè©¦æ¨¡æ¿è®Šæ•¸ï¼Œå¤±æ•—å‰‡å¾ç¶²å€ /toilet_feedback_by_coord/<lat>/<lon> è§£æ
        function getLatLon() {
            let lat = "{{ lat|default('', true) }}";
            let lon = "{{ lon|default('', true) }}";
            if (lat && lon) return {lat, lon};

            // å¾ URL path æŠ“
            const m = decodeURIComponent(location.pathname).match(/\/toilet_feedback_by_coord\/([^/]+)\/([^/]+)/);
            if (m && m[1] && m[2]) return { lat: m[1], lon: m[2] };

            // å¾ address å˜—è©¦ "lat,lon"
            const addrNode = document.querySelector('.addr');
            if (addrNode) {
                const m2 = (addrNode.textContent || '').match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
                if (m2) return { lat: m2[1], lon: m2[2] };
            }
            return {lat:'', lon:''};
        }

        (function drawTrendAndAvg() {
            const { lat, lon } = getLatLon();
            if (!lat || !lon) return;

            // 1) è¶¨å‹¢ï¼†å¹³å‡ï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„åšæ³•ï¼‰
            fetch(`/get_clean_trend_by_coord/${lat}/${lon}`)
              .then(r => r.json())
              .then(data => {
                  const arr = (data && data.data) ? data.data : [];
                  const ctx = document.getElementById('cleanlinessChart').getContext('2d');

                  // è¨ˆç®—å¹³å‡ä¸¦é¡¯ç¤ºåœ¨è—è‰²ç›’
                  const avgNode = document.getElementById('avgPredScore');
                  if (arr.length > 0) {
                      const avg = (arr.reduce((s,x)=>s + (Number(x.score)||0), 0) / arr.length).toFixed(2);
                      if (avgNode) avgNode.textContent = avg;
                  } else {
                      if (avgNode) avgNode.textContent = 'æœªé æ¸¬';
                  }

                  // ç•«åœ–
                  new Chart(ctx, {
                      type: 'line',
                      data: {
                          labels: arr.map((_, i) => `#${i + 1}`),
                          datasets: [{
                              label: 'æ¸…æ½”åº¦é æ¸¬',
                              data: arr.map(x => Number(x.score)||null),
                              borderColor: 'rgba(75, 192, 192, 1)',
                              fill: false,
                              tension: 0.3
                          }]
                      },
                      options: {
                          responsive: true,
                          scales: {
                              x: { title: { display: true, text: 'å›é¥‹æ¬¡æ•¸' } },
                              y: { min: 1, max: 5, title: { display: true, text: 'æ¸…æ½”åº¦' } }
                          }
                      }
                  });
              })
              .catch(err => {
                  console.error('å–å¾—è¶¨å‹¢è³‡æ–™å¤±æ•—:', err);
              });

            // 2) âœ… Nowcast å³æ™‚æ¸…æ½”æŒ‡æ•¸ + 95% CI
            fetch(`/get_nowcast_by_coord/${lat}/${lon}`)
              .then(r => r.json())
              .then(data => {
                  const box = document.getElementById('nowcastText');
                  if (!box) return;
                  if (!data || data.success === false || (data.n !== undefined && data.n === 0)) {
                      box.textContent = 'å³æ™‚æ¸…æ½”æŒ‡æ•¸ï¼šå°šç„¡å³æ™‚è³‡æ–™';
                      return;
                  }
                  const mean = (data.mean !== undefined) ? Number(data.mean).toFixed(2) : 'â€”';
                  const lower = (data.lower !== undefined) ? Number(data.lower).toFixed(2) : 'â€”';
                  const upper = (data.upper !== undefined) ? Number(data.upper).toFixed(2) : 'â€”';
                  const n = (data.n !== undefined) ? data.n : 0;
                  box.textContent = `å³æ™‚æ¸…æ½”æŒ‡æ•¸ï¼š${mean} åˆ†ï¼ˆ95% CIï¼š${lower}â€“${upper}ï¼Œn=${n})`;
              })
              .catch(err => {
                  console.error('å–å¾— Nowcast å¤±æ•—:', err);
                  const box = document.getElementById('nowcastText');
                  if (box) box.textContent = 'å³æ™‚æ¸…æ½”æŒ‡æ•¸ï¼šè¼‰å…¥å¤±æ•—';
              });
        })();
    </script>
</body>
</html>
