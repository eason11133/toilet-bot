<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="t_title">隱私同意 | 廁所幫手</title>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{background:#0b1622;color:#e8f0ff;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .card{max-width:720px;margin:28px auto;padding:22px;border-radius:16px;background:#0f2030;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{font-size:24px;margin:0 0 6px}
    .muted{color:#b8c6d9}
    .row{margin:14px 0}
    .btn{display:inline-block;padding:14px 18px;border-radius:12px;border:none;font-size:16px;cursor:pointer}
    .primary{background:#3578e5;color:#fff}
    .ghost{background:transparent;border:1px solid #30465f;color:#e8f0ff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .me{display:flex;gap:12px;align-items:center;background:#0b1b2a;border:1px solid #1a3149;border-radius:12px;padding:12px}
    .dot{width:14px;height:14px;border-radius:50%;background:#274e74;display:inline-block;margin-right:8px}
    a{color:#8fb9ff}
    code{background:#0b1b2a;border:1px solid #1a3149;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <div class="muted" id="t_banner" style="margin-bottom:10px;">隱私與使用同意</div>
    <h1 id="t_h1">開始前，請先閱讀並同意</h1>

    <div class="row muted" id="t_policy">
      為了幫你找附近廁所與提供回饋，我們需要暫時處理你的 LINE 使用者識別 與（若你選擇「精確模式」）<b>位置資訊</b>。我們承諾：
      <ul>
        <li>僅用於查詢與功能使用，不做商業販售或不當分享</li>
        <li>位置只做即時查詢，不會永久儲存（隱私模式下僅使用近似網格）</li>
        <li>你可隨時撤回同意，並要求刪除紀錄</li>
      </ul>
    </div>

    <div class="row me">
      <div class="dot"></div>
      <div>
        <div id="hello" style="font-weight:600">您好（讀取中…）</div>
        <div class="muted" id="ctxHint">正在從 LINE 取得您的暱稱與 ID</div>
      </div>
    </div>

    <div class="row">
      <label style="display:flex;gap:10px;align-items:flex-start;">
        <input id="agreeChk" type="checkbox" checked />
        <span id="t_chk">我已閱讀並同意《<a href="/privacy" target="_blank" rel="noopener">隱私權政策</a>》與使用條款；我了解若不同意將無法使用本服務。</span>
      </label>
    </div>

    <div class="row" style="display:flex;gap:12px;">
      <button id="okBtn" class="btn primary" disabled>同意並開始使用</button>
      <button id="noBtn" class="btn ghost">不同意</button>
    </div>

    <div class="row muted" id="tips" style="display:none;"></div>
  </div>

  <script>
    /** ===== i18n ===== */
    const I18N = {
      zh: {
        title: "隱私同意 | 廁所幫手",
        banner: "隱私與使用同意",
        h1: "開始前，請先閱讀並同意",
        policy_html: `為了幫你找附近廁所與提供回饋，我們需要暫時處理你的 LINE 使用者識別 與（若你選擇「精確模式」）<b>位置資訊</b>。我們承諾：
          <ul>
            <li>僅用於查詢與功能使用，不做商業販售或不當分享</li>
            <li>位置只做即時查詢，不會永久儲存（隱私模式下僅使用近似網格）</li>
            <li>你可隨時撤回同意，並要求刪除紀錄</li>
          </ul>`,
        hello_loading: "您好（讀取中…）",
        hint_loading: "正在從 LINE 取得您的暱稱與 ID",
        hint_connected: "已連線至 LINE 帳號",
        chk_html: `我已閱讀並同意《<a href="/privacy" target="_blank" rel="noopener">隱私權政策</a>》與使用條款；我了解若不同意將無法使用本服務。`,
        ok: "同意並開始使用",
        ok_sending: "送出中…",
        ok_done: "已同意",
        ok_external_done: "已記錄同意，請返回 LINE 聊天視窗繼續使用。",
        no: "不同意",
        no_msg: "你選擇不同意。部分功能將無法提供。請直接關閉此視窗回到 LINE。",
        timeout: "讀取逾時，請在 LINE 內重新開啟或稍後再試",
        timeout_tip: "若你是從外部瀏覽器開啟，請回到 LINE 聊天室，點機器人提供的按鈕開啟此頁。",
        init_failed: "初始化失敗：",
        submit_failed_prefix: "送出失敗：",
        submit_failed_suffix: "。請稍後再試。",
        missing_liff: "頁面缺少 LIFF_ID，無法初始化 LIFF。",
        missing_liff_tip: "請確認後端 render_template 有傳入 liff_id，或用網址參數帶入，例如：",
        missing_liff_example: "/consent?liffId=你的LIFF_ID"
      },
      en: {
        title: "Privacy Consent | Restroom Helper",
        banner: "Privacy & Consent",
        h1: "Please read and agree before continuing",
        policy_html: `To help you find nearby restrooms and collect feedback, we temporarily process your LINE user ID and, if you choose “Precise mode”, your <b>location</b>. We promise:
          <ul>
            <li>Used only to provide features; not sold or improperly shared</li>
            <li>Location is used for real-time search only and not stored permanently (privacy mode uses approximate grids)</li>
            <li>You can withdraw consent anytime and request deletion</li>
          </ul>`,
        hello_loading: "Hello (loading…)",
        hint_loading: "Getting your display name and ID from LINE",
        hint_connected: "Connected to your LINE account",
        chk_html: `I have read and agree to the <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a> and Terms of Use. I understand I can’t use the service without consent.`,
        ok: "Agree & Start",
        ok_sending: "Submitting…",
        ok_done: "Agreed",
        ok_external_done: "Consent recorded. Please return to LINE to continue.",
        no: "Decline",
        no_msg: "You declined. Some features will be unavailable. You can close this page and return to LINE.",
        timeout: "Timed out. Please open this page inside LINE or try again.",
        timeout_tip: "If you opened this in an external browser, go back to LINE and open it from the bot button.",
        init_failed: "Initialization failed: ",
        submit_failed_prefix: "Submit failed: ",
        submit_failed_suffix: " Please try again later.",
        missing_liff: "This page is missing LIFF_ID, so LIFF cannot be initialized.",
        missing_liff_tip: "Make sure your backend passes liff_id into the template, or pass it via URL query, e.g.:",
        missing_liff_example: "/consent?liffId=YOUR_LIFF_ID"
      }
    };

    function normLang(x){
      x = (x || "").toLowerCase();
      if (x.startsWith("zh")) return "zh";
      return "en";
    }
    function getLang(){
      const p = new URLSearchParams(location.search);
      const q = p.get("lang");
      if (q) return normLang(q);
      try { if (window.liff && typeof liff.getLanguage === "function") return normLang(liff.getLanguage()); } catch {}
      return normLang(navigator.language || "zh");
    }

    const LANG = getLang();
    const T = I18N[LANG] || I18N.zh;

    document.documentElement.lang = (LANG === "en") ? "en" : "zh-Hant";
    document.title = T.title;

    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
    function setHTML(id, v){ const el=document.getElementById(id); if(el) el.innerHTML = v; }
    function showTips(html){
      const tips = document.getElementById("tips");
      tips.style.display = "block";
      tips.innerHTML = html;
    }

    setText("t_title", T.title);
    setText("t_banner", T.banner);
    setText("t_h1", T.h1);
    setHTML("t_policy", T.policy_html);
    setText("hello", T.hello_loading);
    setText("ctxHint", T.hint_loading);
    setHTML("t_chk", T.chk_html);
    setText("okBtn", T.ok);
    setText("noBtn", T.no);

    /** ===== LIFF_ID resolve (template -> query -> empty) ===== */
    // 後端正常情況會把 {{ liff_id }} 替換成真正 ID；若沒替換就會是原字串
    const TEMPLATE_LIFF_ID = "{{ liff_id }}";
    function resolveLiffId(){
      const p = new URLSearchParams(location.search);
      const q = p.get("liffId") || p.get("liff_id") || p.get("LIFF_ID");
      // 1) template 有被替換
      if (TEMPLATE_LIFF_ID && !TEMPLATE_LIFF_ID.includes("{") && TEMPLATE_LIFF_ID.trim().length > 0) {
        return TEMPLATE_LIFF_ID.trim();
      }
      // 2) fallback：用 query string
      if (q && q.trim().length > 0) return q.trim();
      return "";
    }
    const LIFF_ID = resolveLiffId();

    const okBtn   = document.getElementById('okBtn');
    const noBtn   = document.getElementById('noBtn');
    const agree   = document.getElementById('agreeChk');
    const hello   = document.getElementById('hello');
    const ctxHint = document.getElementById('ctxHint');

    let userId = "";
    let displayName = "";
    let sourceType = "line";
    let ua = navigator.userAgent;

    function enableIfReady() {
      okBtn.disabled = !(agree.checked && userId);
    }
    agree.addEventListener('change', enableIfReady);

    function setMissingLiffUI(){
      ctxHint.textContent = T.missing_liff;
      okBtn.disabled = true;
      // 給你 debug 資訊：方便你立刻看到到底拿到什麼
      const safeExample = `<div style="margin-top:10px;">
        <div>${T.missing_liff_tip}</div>
        <div><code>${T.missing_liff_example}</code></div>
        <div style="margin-top:10px;">debug:
          <ul>
            <li>template liff_id = <code>${String(TEMPLATE_LIFF_ID).replaceAll("<","&lt;").replaceAll(">","&gt;")}</code></li>
            <li>resolved LIFF_ID = <code>${String(LIFF_ID).replaceAll("<","&lt;").replaceAll(">","&gt;")}</code></li>
            <li>url = <code>${location.href.replaceAll("<","&lt;").replaceAll(">","&gt;")}</code></li>
          </ul>
        </div>
      </div>`;
      showTips(safeExample);
    }

    async function init() {
      try {
        if (!LIFF_ID) {
          setMissingLiffUI();
          return;
        }

        await liff.init({ liffId: LIFF_ID });

        // 若非 LINE 內打開也可以使用，但需要先登入以取得 profile
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }

        const profile = await liff.getProfile();
        userId = (profile && profile.userId) || "";
        displayName = (profile && profile.displayName) || "";

        if (displayName) {
          hello.textContent = displayName + (LANG === "en" ? "" : " 您好");
          ctxHint.textContent = T.hint_connected;
        }

        sourceType = liff.isInClient() ? "line-client" : "external-browser";

        enableIfReady();

        // 安全網：最多等 6 秒，還是沒有 userId 就顯示引導
        setTimeout(() => {
          if (!userId) {
            ctxHint.textContent = T.timeout;
            showTips(T.timeout_tip);
          }
        }, 6000);

      } catch (e) {
        ctxHint.textContent = T.init_failed + (e && e.message ? e.message : String(e));
        showTips(`<div>debug:
          <ul>
            <li>resolved LIFF_ID = <code>${String(LIFF_ID).replaceAll("<","&lt;").replaceAll(">","&gt;")}</code></li>
            <li>isInClient = <code>${(window.liff && typeof liff.isInClient==="function") ? String(liff.isInClient()) : "n/a"}</code></li>
          </ul>
        </div>`);
      }
    }

    okBtn.addEventListener('click', async () => {
      if (!agree.checked || !userId) return;
      okBtn.disabled = true;
      okBtn.textContent = T.ok_sending;

      try {
        const res = await fetch("/api/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            agree: true,
            userId,
            displayName,
            sourceType,
            ua,
            ts: new Date().toISOString(),
            lang: LANG
          })
        });

        const j = await res.json().catch(()=>({}));
        if (res.ok && j.ok !== false) {
          okBtn.textContent = T.ok_done;
          if (window.liff && typeof liff.isInClient === "function" && liff.isInClient()) {
            setTimeout(() => { try { liff.closeWindow(); } catch {} }, 400);
          } else {
            showTips(T.ok_external_done);
          }
        } else {
          throw new Error(j.message || "consent write failed");
        }

      } catch (e) {
        okBtn.disabled = false;
        okBtn.textContent = T.ok;
        showTips(T.submit_failed_prefix + (e && e.message ? e.message : String(e)) + T.submit_failed_suffix);
      }
    });

    noBtn.addEventListener('click', () => {
      showTips(T.no_msg);
      try { if (window.liff && typeof liff.isInClient === "function" && liff.isInClient()) liff.closeWindow(); } catch {}
    });

    init();
  </script>
</body>
</html>