<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>隱私同意 | 廁所幫手</title>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{background:#0b1622;color:#e8f0ff;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .card{max-width:720px;margin:28px auto;padding:22px;border-radius:16px;background:#0f2030;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{font-size:24px;margin:0 0 6px}
    .muted{color:#b8c6d9}
    .row{margin:14px 0}
    .btn{display:inline-block;padding:14px 18px;border-radius:12px;border:none;font-size:16px}
    .primary{background:#3578e5;color:#fff}
    .ghost{background:transparent;border:1px solid #30465f;color:#e8f0ff}
    .btn:disabled{opacity:.5}
    .me{display:flex;gap:12px;align-items:center;background:#0b1b2a;border:1px solid #1a3149;border-radius:12px;padding:12px}
    .dot{width:14px;height:14px;border-radius:50%;background:#274e74;display:inline-block;margin-right:8px}
    a{color:#8fb9ff}
  </style>
</head>
<body>
  <div class="card">
    <div class="muted" style="margin-bottom:10px;">隱私與使用同意</div>
    <h1>開始前，請先閱讀並同意</h1>
    <div class="row muted">
      為了幫你找附近廁所與提供回饋，我們需要暫時處理你的 LINE 使用者識別 與（若你選擇「精確模式」）<b>位置資訊</b>。我們承諾：
      <ul>
        <li>僅用於查詢與功能使用，不做商業販售或不當分享</li>
        <li>位置只做即時查詢，不會永久儲存（隱私模式下僅使用近似網格）</li>
        <li>你可隨時撤回同意，並要求刪除紀錄</li>
      </ul>
    </div>

    <div class="row me">
      <div class="dot"></div>
      <div>
        <div id="hello" style="font-weight:600">您好（讀取中…）</div>
        <div class="muted" id="ctxHint">正在從 LINE 取得您的暱稱與 ID</div>
      </div>
    </div>

    <div class="row">
      <label style="display:flex;gap:10px;align-items:flex-start;">
        <input id="agreeChk" type="checkbox" checked />
        <span>我已閱讀並同意《<a href="/privacy" target="_blank">隱私權政策</a>》與使用條款；我了解若不同意將無法使用本服務。</span>
      </label>
    </div>

    <div class="row" style="display:flex;gap:12px;">
      <button id="okBtn" class="btn primary" disabled>同意並開始使用</button>
      <button id="noBtn" class="btn ghost">不同意</button>
    </div>

    <div class="row muted" id="tips" style="display:none;"></div>
  </div>

  <script>
    const LIFF_ID = "2007674330-0XpoR2dW";
    const okBtn   = document.getElementById('okBtn');
    const noBtn   = document.getElementById('noBtn');
    const agree   = document.getElementById('agreeChk');
    const hello   = document.getElementById('hello');
    const ctxHint = document.getElementById('ctxHint');
    const tips    = document.getElementById('tips');

    let userId = "";
    let displayName = "";
    let sourceType = "line";
    let ua = navigator.userAgent;

    function enableIfReady() {
      okBtn.disabled = !(agree.checked && userId);
    }
    agree.addEventListener('change', enableIfReady);

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        // 若非 LINE 內打開也可以使用，但需要先登入以取得 profile
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }
        const profile = await liff.getProfile(); // 會帶回 userId
        userId = (profile && profile.userId) || "";
        displayName = (profile && profile.displayName) || "";

        // 顯示暱稱
        if (displayName) {
          hello.textContent = displayName + " 您好";
          ctxHint.textContent = "已連線至 LINE 帳號";
        }

        // 來源型態：在 LINE 客戶端內 or 外部瀏覽器
        sourceType = liff.isInClient() ? "line-client" : "external-browser";

        enableIfReady();

        // 安全網：最多等 6 秒，還是沒有 userId 就顯示引導
        setTimeout(() => {
          if (!userId) {
            ctxHint.textContent = "讀取逾時，請在 LINE 內重新開啟或稍後再試";
            tips.style.display = "block";
            tips.innerHTML = "若你是從外部瀏覽器開啟，請回到 LINE 聊天室，點機器人提供的按鈕開啟此頁。";
          }
        }, 6000);
      } catch (e) {
        ctxHint.textContent = "初始化失敗：" + (e.message || e);
        tips.style.display = "block";
      }
    }

    okBtn.addEventListener('click', async () => {
      if (!agree.checked || !userId) return;
      okBtn.disabled = true;
      okBtn.textContent = "送出中…";
      try {
        const res = await fetch("/api/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            agree: true,
            userId,
            displayName,
            sourceType,
            ua,
            ts: new Date().toISOString()
          })
        });
        const j = await res.json().catch(()=>({}));
        if (res.ok && j.ok !== false) {
          okBtn.textContent = "已同意";
          // 在 LINE 內可直接關閉
          if (liff.isInClient()) {
            setTimeout(() => liff.closeWindow(), 400);
          } else {
            tips.style.display = "block";
            tips.innerHTML = "已記錄同意，請返回 LINE 聊天視窗繼續使用。";
          }
        } else {
          throw new Error(j.message || "同意寫入失敗");
        }
      } catch (e) {
        okBtn.disabled = false;
        okBtn.textContent = "同意並開始使用";
        tips.style.display = "block";
        tips.innerHTML = "送出失敗：" + (e.message||e) + "。請稍後再試。";
      }
    });

    noBtn.addEventListener('click', () => {
      tips.style.display = "block";
      tips.innerHTML = "你選擇不同意。部分功能將無法提供。請直接關閉此視窗回到 LINE。";
      try { if (liff.isInClient()) liff.closeWindow(); } catch {}
    });

    init();
  </script>
</body>
</html>
